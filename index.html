<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>reMarkable Pro Move Calendar Generator</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="config.js"></script>
    <style>
        .remarkable-preview {
            aspect-ratio: 4/3;
            background: linear-gradient(145deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px solid #dee2e6;
            border-radius: 12px;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #dee2e6;
        }
        .time-slot {
            min-height: 40px;
            border-bottom: 1px dotted #adb5bd;
        }
        .sync-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .eink-optimized {
            filter: contrast(1.2) brightness(1.1);
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <i class="fas fa-calendar-alt text-3xl"></i>
                    <div>
                        <h1 class="text-2xl font-bold">reMarkable Pro Move Calendar Generator</h1>
                        <p class="text-blue-100">Professional calendar templates with Google Calendar sync</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="authStatus" class="flex items-center space-x-2">
                        <div class="sync-indicator bg-yellow-400" id="syncIndicator"></div>
                        <span class="text-sm">Not Connected</span>
                    </div>
                    <button id="authButton" class="bg-white text-purple-600 px-4 py-2 rounded-lg hover:bg-gray-100 transition-colors">
                        <i class="fab fa-google mr-2"></i>Connect Google
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container mx-auto px-6 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <!-- Configuration Panel -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                    <h2 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-cog mr-2 text-purple-600"></i>
                        Template Configuration
                    </h2>

                    <!-- Week Selection -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Week Starting</label>
                        <input type="date" id="weekStart" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>

                    <!-- Color Theme -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">E-ink Optimization</label>
                        <div class="grid grid-cols-2 gap-2">
                            <button class="theme-btn p-3 border-2 border-gray-300 rounded-lg text-center hover:border-purple-500 transition-colors" data-theme="sage">
                                <div class="w-full h-4 bg-gradient-to-r from-gray-300 to-gray-500 rounded mb-1"></div>
                                <span class="text-xs">Sage Green</span>
                            </button>
                            <button class="theme-btn p-3 border-2 border-gray-300 rounded-lg text-center hover:border-purple-500 transition-colors" data-theme="classic">
                                <div class="w-full h-4 bg-gradient-to-r from-gray-400 to-gray-600 rounded mb-1"></div>
                                <span class="text-xs">Classic</span>
                            </button>
                        </div>
                    </div>

                    <!-- Layout Options -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Layout Settings</label>
                        <div class="space-y-2">
                            <label class="flex items-center">
                                <input type="checkbox" id="showHabits" class="mr-2" checked>
                                <span class="text-sm">Include Habit Tracker</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="showDecisions" class="mr-2" checked>
                                <span class="text-sm">Decision Framework</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="showEnergy" class="mr-2" checked>
                                <span class="text-sm">Energy Tracker</span>
                            </label>
                        </div>
                    </div>

                    <!-- Time Format -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Time Format</label>
                        <select id="timeFormat" class="w-full p-2 border border-gray-300 rounded-lg">
                            <option value="24">24-hour</option>
                            <option value="12">12-hour</option>
                        </select>
                    </div>
                </div>

                <!-- Google Calendar Integration -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fab fa-google mr-2 text-blue-600"></i>
                        Calendar Integration
                    </h2>

                    <div id="calendarList" class="space-y-2">
                        <div class="text-gray-500 text-center py-4">
                            Connect Google Calendar to sync events
                        </div>
                    </div>

                    <div class="mt-4">
                        <button id="syncNow" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50" disabled>
                            <i class="fas fa-sync-alt mr-2"></i>
                            Sync Events
                        </button>
                    </div>
                </div>
            </div>

            <!-- Preview Panel -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-xl font-bold flex items-center">
                            <i class="fas fa-eye mr-2 text-green-600"></i>
                            Template Preview
                        </h2>
                        <div class="flex items-center space-x-2">
                            <span class="text-sm text-gray-600">2880 × 2160px</span>
                            <div class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs">
                                reMarkable Pro Move Optimized
                            </div>
                        </div>
                    </div>

                    <!-- Page Navigation -->
                    <div class="flex items-center justify-center mb-4 space-x-2">
                        <button class="page-nav-btn bg-purple-600 text-white px-3 py-1 rounded text-sm hover:bg-purple-700 transition-colors" data-page="0">Week</button>
                        <button class="page-nav-btn bg-gray-300 text-gray-700 px-3 py-1 rounded text-sm hover:bg-gray-400 transition-colors" data-page="1">Mon</button>
                        <button class="page-nav-btn bg-gray-300 text-gray-700 px-3 py-1 rounded text-sm hover:bg-gray-400 transition-colors" data-page="2">Tue</button>
                        <button class="page-nav-btn bg-gray-300 text-gray-700 px-3 py-1 rounded text-sm hover:bg-gray-400 transition-colors" data-page="3">Wed</button>
                        <button class="page-nav-btn bg-gray-300 text-gray-700 px-3 py-1 rounded text-sm hover:bg-gray-400 transition-colors" data-page="4">Thu</button>
                        <button class="page-nav-btn bg-gray-300 text-gray-700 px-3 py-1 rounded text-sm hover:bg-gray-400 transition-colors" data-page="5">Fri</button>
                        <button class="page-nav-btn bg-gray-300 text-gray-700 px-3 py-1 rounded text-sm hover:bg-gray-400 transition-colors" data-page="6">Sat</button>
                        <button class="page-nav-btn bg-gray-300 text-gray-700 px-3 py-1 rounded text-sm hover:bg-gray-400 transition-colors" data-page="7">Sun</button>
                    </div>

                    <!-- Preview Container -->
                    <div class="remarkable-preview eink-optimized p-4">
                        <div id="previewContent">
                            <!-- Weekly Overview (Default View) -->
                            <div id="weeklyPreview">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-lg font-bold text-gray-800">Week Overview</h3>
                                    <div class="flex items-center space-x-2">
                                        <span class="text-xs text-gray-600">Week 47, 2024</span>
                                        <div class="sync-indicator bg-green-400"></div>
                                    </div>
                                </div>

                                <!-- Mini Calendar -->
                                <div class="calendar-grid mb-4 text-xs">
                                    <div class="bg-gray-200 p-1 text-center font-bold">Mon</div>
                                    <div class="bg-gray-200 p-1 text-center font-bold">Tue</div>
                                    <div class="bg-gray-200 p-1 text-center font-bold">Wed</div>
                                    <div class="bg-gray-200 p-1 text-center font-bold">Thu</div>
                                    <div class="bg-gray-200 p-1 text-center font-bold">Fri</div>
                                    <div class="bg-gray-200 p-1 text-center font-bold">Sat</div>
                                    <div class="bg-gray-200 p-1 text-center font-bold">Sun</div>

                                    <div class="bg-white p-2 text-center">
                                        <div class="font-medium">18</div>
                                        <div class="w-2 h-1 bg-blue-400 mx-auto mt-1 rounded"></div>
                                    </div>
                                    <div class="bg-white p-2 text-center">19</div>
                                    <div class="bg-white p-2 text-center">20</div>
                                    <div class="bg-white p-2 text-center">21</div>
                                    <div class="bg-white p-2 text-center">22</div>
                                    <div class="bg-white p-2 text-center">23</div>
                                    <div class="bg-white p-2 text-center">24</div>
                                </div>

                                <!-- Weekly Goals -->
                                <div class="grid grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <h4 class="text-sm font-bold mb-2">Weekly Goals</h4>
                                        <div class="space-y-1">
                                            <div class="flex items-center text-xs">
                                                <div class="w-3 h-3 border border-gray-400 rounded mr-2"></div>
                                                <span>Complete project proposal</span>
                                            </div>
                                            <div class="flex items-center text-xs">
                                                <div class="w-3 h-3 border border-gray-400 rounded mr-2"></div>
                                                <span>Review quarterly metrics</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <h4 class="text-sm font-bold mb-2">Decisions Pending</h4>
                                        <div class="space-y-1">
                                            <div class="flex items-center text-xs">
                                                <div class="w-2 h-2 bg-yellow-400 rounded-full mr-2"></div>
                                                <span>Budget allocation</span>
                                            </div>
                                            <div class="flex items-center text-xs">
                                                <div class="w-2 h-2 bg-orange-400 rounded-full mr-2"></div>
                                                <span>Team structure</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Habit Tracker -->
                                <div>
                                    <h4 class="text-sm font-bold mb-2">Habit Tracker</h4>
                                    <div class="grid grid-cols-7 gap-1 text-xs">
                                        <div class="text-center">M</div>
                                        <div class="text-center">T</div>
                                        <div class="text-center">W</div>
                                        <div class="text-center">T</div>
                                        <div class="text-center">F</div>
                                        <div class="text-center">S</div>
                                        <div class="text-center">S</div>

                                        <div class="w-4 h-4 bg-green-300 rounded-full mx-auto"></div>
                                        <div class="w-4 h-4 bg-green-300 rounded-full mx-auto"></div>
                                        <div class="w-4 h-4 border border-gray-400 rounded-full mx-auto"></div>
                                        <div class="w-4 h-4 border border-gray-400 rounded-full mx-auto"></div>
                                        <div class="w-4 h-4 border border-gray-400 rounded-full mx-auto"></div>
                                        <div class="w-4 h-4 border border-gray-400 rounded-full mx-auto"></div>
                                        <div class="w-4 h-4 border border-gray-400 rounded-full mx-auto"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Daily View Template (Hidden by default) -->
                            <div id="dailyPreview" class="hidden">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-lg font-bold text-gray-800">Monday, Nov 18, 2024</h3>
                                    <div class="flex items-center space-x-2">
                                        <button class="text-xs bg-gray-200 px-2 py-1 rounded">← Week</button>
                                        <div class="sync-indicator bg-green-400"></div>
                                    </div>
                                </div>

                                <div class="grid grid-cols-12 gap-2 text-xs">
                                    <!-- Time Column -->
                                    <div class="col-span-2 space-y-2">
                                        <div class="time-slot text-right pr-2 text-gray-600">06:00</div>
                                        <div class="time-slot text-right pr-2 text-gray-600">07:00</div>
                                        <div class="time-slot text-right pr-2 text-gray-600">08:00</div>
                                        <div class="time-slot text-right pr-2 text-gray-600">09:00</div>
                                        <div class="time-slot text-right pr-2 text-gray-600">10:00</div>
                                        <div class="time-slot text-right pr-2 text-gray-600">11:00</div>
                                        <div class="time-slot text-right pr-2 text-gray-600">12:00</div>
                                        <div class="time-slot text-right pr-2 text-gray-600">13:00</div>
                                    </div>

                                    <!-- Schedule Column -->
                                    <div class="col-span-7 space-y-2">
                                        <div class="time-slot"></div>
                                        <div class="time-slot bg-blue-100 p-1 rounded border-l-2 border-blue-400">
                                            <div class="font-medium">Morning Standup</div>
                                        </div>
                                        <div class="time-slot"></div>
                                        <div class="time-slot bg-green-100 p-1 rounded border-l-2 border-green-400">
                                            <div class="font-medium">Project Review</div>
                                        </div>
                                        <div class="time-slot"></div>
                                        <div class="time-slot"></div>
                                        <div class="time-slot bg-orange-100 p-1 rounded border-l-2 border-orange-400">
                                            <div class="font-medium">Lunch Meeting</div>
                                        </div>
                                        <div class="time-slot"></div>
                                    </div>

                                    <!-- Sidebar -->
                                    <div class="col-span-3">
                                        <div class="bg-gray-50 p-2 rounded mb-2">
                                            <h5 class="font-bold mb-1">Daily Focus</h5>
                                            <div class="text-xs text-gray-600">Complete design review</div>
                                        </div>

                                        <div class="bg-gray-50 p-2 rounded mb-2">
                                            <h5 class="font-bold mb-1">Priority Tasks</h5>
                                            <div class="space-y-1">
                                                <div class="flex items-center">
                                                    <div class="w-2 h-2 border border-gray-400 rounded mr-1"></div>
                                                    <span class="text-xs">Update documentation</span>
                                                </div>
                                                <div class="flex items-center">
                                                    <div class="w-2 h-2 border border-gray-400 rounded mr-1"></div>
                                                    <span class="text-xs">Code review</span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="bg-gray-50 p-2 rounded">
                                            <h5 class="font-bold mb-1">Energy</h5>
                                            <div class="flex space-x-1">
                                                <div class="w-2 h-2 bg-green-400 rounded-full"></div>
                                                <div class="w-2 h-2 bg-green-400 rounded-full"></div>
                                                <div class="w-2 h-2 bg-green-400 rounded-full"></div>
                                                <div class="w-2 h-2 bg-gray-300 rounded-full"></div>
                                                <div class="w-2 h-2 bg-gray-300 rounded-full"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Export Actions -->
                    <div class="mt-6 flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <div class="text-sm text-gray-600">
                                <i class="fas fa-info-circle mr-1"></i>
                                8 pages • PDF format • Google sync enabled
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button id="generatePDF" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors">
                                <i class="fas fa-download mr-2"></i>
                                Generate PDF
                            </button>
                            <button id="deployToReplit" class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition-colors">
                                <i class="fas fa-rocket mr-2"></i>
                                Deploy to Replit
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Bar -->
        <div class="mt-8 bg-white rounded-xl shadow-lg p-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <div class="w-3 h-3 bg-green-400 rounded-full"></div>
                        <span class="text-sm text-gray-600">Template Ready</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="w-3 h-3 bg-blue-400 rounded-full"></div>
                        <span class="text-sm text-gray-600">Google Calendar: <span id="calendarStatus">Disconnected</span></span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="w-3 h-3 bg-yellow-400 rounded-full"></div>
                        <span class="text-sm text-gray-600">Export: Ready</span>
                    </div>
                </div>
                <div class="text-sm text-gray-500">
                    Last updated: <span id="lastUpdate">Never</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let gapi_loaded = false;
        let isSignedIn = false;
        let currentPage = 0;
        let calendarEvents = [];
        let tokenClient = null;
        let accessToken = null;

        // Initialize Google API (Modern Google Identity Services)
        function initializeGapi() {
            console.log('Starting Google API initialization...');

            // Check if gapi is available
            if (typeof gapi === 'undefined') {
                console.error('Google API script not loaded');
                setTimeout(initializeGapi, 500);
                return;
            }

            // Check if Google Identity Services is available
            if (typeof google === 'undefined' || !google.accounts) {
                console.error('Google Identity Services not loaded');
                setTimeout(initializeGapi, 500);
                return;
            }

            // Check if config is available
            if (!window.GOOGLE_CONFIG) {
                console.error('Google config not loaded');
                setTimeout(initializeGapi, 500);
                return;
            }

            // Initialize gapi client (only for API calls, not auth)
            gapi.load('client', () => {
                console.log('Google API client loaded, initializing...');
                
                gapi.client.init({
                    apiKey: window.GOOGLE_CONFIG.apiKey,
                    discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest']
                }).then(() => {
                    console.log('Google API client initialized successfully');
                    gapi_loaded = true;
                    
                    // Initialize the token client for OAuth (new way)
                    tokenClient = google.accounts.oauth2.initTokenClient({
                        client_id: window.GOOGLE_CONFIG.clientId,
                        scope: 'https://www.googleapis.com/auth/calendar.readonly',
                        callback: (response) => {
                            if (response.error !== undefined) {
                                console.error('OAuth error:', response.error);
                                alert('Authentication failed: ' + response.error);
                                return;
                            }
                            console.log('OAuth successful, got access token');
                            accessToken = response.access_token;
                            gapi.client.setToken({access_token: accessToken});
                            isSignedIn = true;
                            updateAuthUI();
                        }
                    });
                    
                    console.log('Token client initialized');
                    updateAuthUI();
                    
                }).catch(error => {
                    console.error('Failed to initialize Google API client:', error);
                    gapi_loaded = false;
                    
                    const authButton = document.getElementById('authButton');
                    authButton.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i>Setup Required';
                    authButton.disabled = true;
                    
                    alert('Failed to initialize Google API: ' + (error.details || error.message || error));
                });
            });
        }

        // Update authentication UI
        function updateAuthUI() {
            const authButton = document.getElementById('authButton');
            const authStatus = document.getElementById('authStatus');
            const syncIndicator = document.getElementById('syncIndicator');
            const syncButton = document.getElementById('syncNow');
            const calendarStatus = document.getElementById('calendarStatus');

            if (isSignedIn) {
                authButton.innerHTML = '<i class="fas fa-sign-out-alt mr-2"></i>Disconnect';
                authStatus.querySelector('span').textContent = 'Connected';
                syncIndicator.className = 'sync-indicator bg-green-400';
                syncButton.disabled = false;
                calendarStatus.textContent = 'Connected';
                loadCalendars();
            } else {
                authButton.innerHTML = '<i class="fab fa-google mr-2"></i>Connect Google';
                authStatus.querySelector('span').textContent = 'Not Connected';
                syncIndicator.className = 'sync-indicator bg-yellow-400';
                syncButton.disabled = true;
                calendarStatus.textContent = 'Disconnected';
            }
        }

        // Handle authentication (Modern Google Identity Services)
        function handleAuth() {
            console.log('=== AUTH BUTTON CLICKED ===');
            console.log('gapi_loaded:', gapi_loaded);
            console.log('isSignedIn:', isSignedIn);
            console.log('tokenClient:', tokenClient);
            console.log('Current domain:', window.location.hostname);
            console.log('Client ID being used:', window.GOOGLE_CONFIG?.clientId);
            
            if (!gapi_loaded || !tokenClient) {
                console.error('Google API not ready yet');
                console.log('gapi_loaded:', gapi_loaded, 'tokenClient:', tokenClient);
                alert('Google API is still loading. Please try again in a moment.');
                return;
            }
            
            if (isSignedIn) {
                console.log('Signing out...');
                // Revoke the token
                if (accessToken) {
                    google.accounts.oauth2.revoke(accessToken, () => {
                        console.log('Token revoked');
                    });
                }
                
                // Clear the token
                gapi.client.setToken(null);
                accessToken = null;
                isSignedIn = false;
                updateAuthUI();
                
                // Clear calendar list
                const calendarListEl = document.getElementById('calendarList');
                calendarListEl.innerHTML = '<div class="text-gray-500 text-center py-4">Connect Google Calendar to sync events</div>';
                
            } else {
                console.log('=== STARTING OAUTH FLOW ===');
                console.log('About to request access token...');
                try {
                    // Request an access token (this will open the OAuth popup)
                    tokenClient.requestAccessToken({
                        prompt: 'consent',
                        hint: 'user@example.com'
                    });
                    console.log('requestAccessToken called successfully');
                } catch (error) {
                    console.error('Error requesting access token:', error);
                    alert('Error starting authentication: ' + error.message);
                }
            }
        }

        // Load user calendars
        async function loadCalendars() {
            try {
                const response = await gapi.client.calendar.calendarList.list({
                    showHidden: true,
                    showDeleted: false
                });
                const calendars = response.result.items;

                console.log('Found calendars:', calendars.length);
                calendars.forEach(cal => console.log(`Calendar: ${cal.summary} (${cal.id}) - Primary: ${cal.primary}`));

                const calendarListEl = document.getElementById('calendarList');
                calendarListEl.innerHTML = calendars.map(calendar => {
                    const isMainCalendar = calendar.primary || calendar.id === calendar.id.split('@')[0] + '@gmail.com';
                    return `
                        <label class="flex items-center space-x-2 p-2 hover:bg-gray-50 rounded border ${isMainCalendar ? 'border-blue-200 bg-blue-50' : 'border-gray-200'}">
                            <input type="checkbox" class="calendar-checkbox" data-calendar-id="${calendar.id}" ${calendar.primary ? 'checked' : ''}>
                            <div class="w-4 h-4 rounded" style="background-color: ${calendar.backgroundColor || '#3b82f6'}"></div>
                            <div class="flex flex-col">
                                <span class="text-sm font-medium">${calendar.summary}</span>
                                <span class="text-xs text-gray-500">${calendar.accessRole} ${isMainCalendar ? '(Main)' : ''}</span>
                            </div>
                        </label>
                    `;
                }).join('');

                // Update status
                const calendarStatus = document.getElementById('calendarStatus');
                calendarStatus.textContent = `${calendars.length} calendars found`;

            } catch (error) {
                console.error('Error loading calendars:', error);
                const calendarListEl = document.getElementById('calendarList');
                calendarListEl.innerHTML = `
                    <div class="text-red-500 text-center py-4">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        Error loading calendars: ${error.result?.error?.message || error.message}
                    </div>
                `;
            }
        }

        // Sync calendar events
        async function syncCalendarEvents() {
            if (!isSignedIn) return;

            const selectedCalendars = Array.from(document.querySelectorAll('.calendar-checkbox:checked'))
                .map(cb => cb.dataset.calendarId);

            const weekStart = document.getElementById('weekStart').value;
            if (!weekStart) {
                alert('Please select a week start date');
                return;
            }

            const startDate = new Date(weekStart);
            const endDate = new Date(startDate);
            endDate.setDate(endDate.getDate() + 7);

            calendarEvents = [];

            for (const calendarId of selectedCalendars) {
                try {
                    const response = await gapi.client.calendar.events.list({
                        calendarId: calendarId,
                        timeMin: startDate.toISOString(),
                        timeMax: endDate.toISOString(),
                        singleEvents: true,
                        orderBy: 'startTime'
                    });

                    calendarEvents.push(...response.result.items);
                } catch (error) {
                    console.error('Error fetching events:', error);
                }
            }

            updateLastUpdateTime();
            refreshPreview();
        }

        // Update preview based on current page
        function refreshPreview() {
            // This would update the preview based on current settings and events
            // For now, just update the last update time
            updateLastUpdateTime();
        }

        // Switch preview pages
        function switchPage(pageIndex) {
            currentPage = pageIndex;

            // Update navigation buttons
            document.querySelectorAll('.page-nav-btn').forEach((btn, index) => {
                if (index === pageIndex) {
                    btn.className = 'page-nav-btn bg-purple-600 text-white px-3 py-1 rounded text-sm hover:bg-purple-700 transition-colors';
                } else {
                    btn.className = 'page-nav-btn bg-gray-300 text-gray-700 px-3 py-1 rounded text-sm hover:bg-gray-400 transition-colors';
                }
            });

            // Show/hide preview content
            const weeklyPreview = document.getElementById('weeklyPreview');
            const dailyPreview = document.getElementById('dailyPreview');

            if (pageIndex === 0) {
                weeklyPreview.classList.remove('hidden');
                dailyPreview.classList.add('hidden');
            } else {
                weeklyPreview.classList.add('hidden');
                dailyPreview.classList.remove('hidden');

                // Update daily preview for selected day
                const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
                const dayName = days[pageIndex - 1];
                dailyPreview.querySelector('h3').textContent = `${dayName}, Nov ${17 + pageIndex}, 2024`;
            }
        }

        // Generate PDF
        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'landscape',
                unit: 'px',
                format: [2880, 2160]
            });

            // This is a simplified PDF generation
            // In a real implementation, you would render each page with proper layout
            for (let page = 0; page < 8; page++) {
                if (page > 0) doc.addPage();

                doc.setFontSize(24);
                if (page === 0) {
                    doc.text('reMarkable Pro Move - Weekly Overview', 100, 100);
                } else {
                    const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
                    doc.text(`reMarkable Pro Move - ${days[page - 1]}`, 100, 100);
                }

                // Add grid lines and template structure
                doc.setDrawColor(128, 128, 128);
                doc.setLineWidth(1);

                // Draw basic grid structure
                for (let i = 0; i < 24; i++) {
                    const y = 200 + (i * 60);
                    doc.line(50, y, 2800, y);
                    doc.text(`${i.toString().padStart(2, '0')}:00`, 20, y + 15);
                }

                // Add vertical lines for time blocks
                for (let i = 0; i < 7; i++) {
                    const x = 300 + (i * 350);
                    doc.line(x, 150, x, 2000);
                }
            }

            const weekStart = document.getElementById('weekStart').value || new Date().toISOString().split('T')[0];
            doc.save(`remarkable_calendar_${weekStart}.pdf`);

            updateLastUpdateTime();
        }

        // Deploy to Replit (placeholder)
        function deployToReplit() {
            // This would integrate with Replit API to deploy the application
            // For now, show a placeholder message
            alert('Deploy to Replit functionality would integrate with Replit API to push this application to the specified Git repository.');
        }

        // Update last update time
        function updateLastUpdateTime() {
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        }

        // Initialize date input with current week
        function initializeDateInput() {
            const today = new Date();
            const monday = new Date(today);
            monday.setDate(today.getDate() - today.getDay() + 1);
            document.getElementById('weekStart').value = monday.toISOString().split('T')[0];
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            initializeDateInput();
            updateLastUpdateTime();

            // Auth button
            document.getElementById('authButton').addEventListener('click', handleAuth);

            // Sync button
            document.getElementById('syncNow').addEventListener('click', syncCalendarEvents);

            // Page navigation
            document.querySelectorAll('.page-nav-btn').forEach((btn, index) => {
                btn.addEventListener('click', () => switchPage(index));
            });

            // Generate PDF button
            document.getElementById('generatePDF').addEventListener('click', generatePDF);

            // Deploy button
            document.getElementById('deployToReplit').addEventListener('click', deployToReplit);

            // Configuration changes
            document.getElementById('weekStart').addEventListener('change', refreshPreview);
            document.getElementById('timeFormat').addEventListener('change', refreshPreview);
            document.getElementById('showHabits').addEventListener('change', refreshPreview);
            document.getElementById('showDecisions').addEventListener('change', refreshPreview);
            document.getElementById('showEnergy').addEventListener('change', refreshPreview);

            // Theme selection
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.theme-btn').forEach(b => 
                        b.classList.remove('border-purple-500'));
                    e.target.closest('.theme-btn').classList.add('border-purple-500');
                    refreshPreview();
                });
            });

            // Set default theme
            document.querySelector('.theme-btn[data-theme="sage"]').classList.add('border-purple-500');

            // Show loading state initially
            const authButton = document.getElementById('authButton');
            authButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Loading...';
            authButton.disabled = true;

            // Initialize Google API when page loads (after a delay to ensure all resources are loaded)
            setTimeout(initializeGapi, 1000);
        });
    </script>
</body>
</html>