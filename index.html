<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>reMarkable Pro Move Calendar Generator</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="config.js"></script>
    <style>
        .remarkable-preview {
            aspect-ratio: 4/3;
            background: #ffffff;
            border: 2px solid #333333;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }
        .franklin-weekly-grid {
            display: grid;
            grid-template-columns: 45px repeat(7, minmax(60px, 1fr));
            grid-template-rows: auto repeat(16, 20px);
            gap: 0;
            background: #333333;
            border: 1px solid #333333;
            font-family: 'Courier New', monospace;
            overflow: auto;
            max-height: 380px;
            width: 100%;
        }
        .franklin-daily-grid {
            display: grid;
            grid-template-columns: 60px 1fr 140px;
            gap: 8px;
            height: 100%;
            font-family: 'Courier New', monospace;
        }
        .franklin-time-header {
            background: #333333;
            color: white;
            padding: 6px 4px;
            font-size: 10px;
            font-weight: bold;
            text-align: center;
        }
        .franklin-day-header {
            background: #333333;
            color: white;
            text-align: center;
            font-weight: bold;
            font-size: 9px;
            padding: 4px 1px;
        }
        .franklin-time-label {
            background: #f8f9fa;
            padding: 1px;
            font-size: 7px;
            font-weight: bold;
            text-align: center;
            border-right: 1px solid #333333;
            border-bottom: 1px solid #eeeeee;
            height: 20px;
            line-height: 18px;
        }
        .franklin-day-cell {
            background: #ffffff;
            padding: 1px;
            min-height: 18px;
            border-right: 1px solid #dddddd;
            border-bottom: 1px solid #eeeeee;
            position: relative;
            font-size: 6px;
            overflow: hidden;
        }
        .franklin-event {
            background: #e8e8e8;
            border-left: 2px solid #333333;
            padding: 0px 1px;
            margin: 0;
            font-size: 6px;
            font-weight: bold;
            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
            line-height: 1.0;
            cursor: pointer;
            transition: background-color 0.2s;
            display: block;
            width: 100%;
        }
        .franklin-event:hover {
            background: #d0d0d0;
            border-left-color: #000000;
        }
        .franklin-priority-section {
            background: #f8f9fa;
            border: 1px solid #333333;
            padding: 6px;
            margin: 3px 0;
        }
        .franklin-section-title {
            font-weight: bold;
            font-size: 10px;
            border-bottom: 1px solid #333333;
            padding-bottom: 2px;
            margin-bottom: 4px;
            text-transform: uppercase;
        }
        .franklin-daily-time-column {
            border-right: 2px solid #333333;
        }
        .franklin-daily-time-slot {
            height: 24px;
            border-bottom: 1px solid #cccccc;
            background: #f8f9fa;
            font-size: 9px;
            font-weight: bold;
            text-align: center;
            padding: 2px;
        }
        .franklin-daily-schedule-slot {
            height: 24px;
            border-bottom: 1px solid #cccccc;
            background: #ffffff;
            padding: 2px;
            position: relative;
        }
        .sync-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .eink-optimized {
            filter: contrast(1.2) brightness(1.1);
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <i class="fas fa-calendar-alt text-3xl"></i>
                    <div>
                        <h1 class="text-2xl font-bold">reMarkable Pro Move Calendar Generator</h1>
                        <p class="text-blue-100">Professional calendar templates with Google Calendar sync</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="authStatus" class="flex items-center space-x-2">
                        <div class="sync-indicator bg-yellow-400" id="syncIndicator"></div>
                        <span class="text-sm">Not Connected</span>
                    </div>
                    <button id="authButton" class="bg-white text-purple-600 px-4 py-2 rounded-lg hover:bg-gray-100 transition-colors">
                        <i class="fab fa-google mr-2"></i>Connect Google
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container mx-auto px-6 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <!-- Configuration Panel -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                    <h2 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-cog mr-2 text-purple-600"></i>
                        Template Configuration
                    </h2>

                    <!-- Week Selection -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Week Starting</label>
                        <input type="date" id="weekStart" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>

                    <!-- Color Theme -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">E-ink Optimization</label>
                        <div class="grid grid-cols-2 gap-2">
                            <button class="theme-btn p-3 border-2 border-gray-300 rounded-lg text-center hover:border-purple-500 transition-colors" data-theme="sage">
                                <div class="w-full h-4 bg-gradient-to-r from-gray-300 to-gray-500 rounded mb-1"></div>
                                <span class="text-xs">Sage Green</span>
                            </button>
                            <button class="theme-btn p-3 border-2 border-gray-300 rounded-lg text-center hover:border-purple-500 transition-colors" data-theme="classic">
                                <div class="w-full h-4 bg-gradient-to-r from-gray-400 to-gray-600 rounded mb-1"></div>
                                <span class="text-xs">Classic</span>
                            </button>
                        </div>
                    </div>

                    <!-- Layout Options -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Layout Settings</label>
                        <div class="space-y-2">
                            <label class="flex items-center">
                                <input type="checkbox" id="showHabits" class="mr-2" checked>
                                <span class="text-sm">Include Habit Tracker</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="showDecisions" class="mr-2" checked>
                                <span class="text-sm">Decision Framework</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="showEnergy" class="mr-2" checked>
                                <span class="text-sm">Energy Tracker</span>
                            </label>
                        </div>
                    </div>

                    <!-- Time Format -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Time Format</label>
                        <select id="timeFormat" class="w-full p-2 border border-gray-300 rounded-lg">
                            <option value="24">24-hour</option>
                            <option value="12">12-hour</option>
                        </select>
                    </div>
                </div>

                <!-- Google Calendar Integration -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fab fa-google mr-2 text-blue-600"></i>
                        Calendar Integration
                    </h2>

                    <div id="calendarList" class="space-y-2">
                        <div class="text-gray-500 text-center py-4">
                            Connect Google Calendar to sync events
                        </div>
                    </div>

                    <!-- Sync Range Options -->
                    <div class="mt-4 mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Sync Range</label>
                        <div class="space-y-2">
                            <label class="flex items-center">
                                <input type="radio" name="syncRange" value="week" class="mr-2" checked>
                                <span class="text-sm">Current Week</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="syncRange" value="full" class="mr-2">
                                <span class="text-sm font-bold text-purple-600">Full Range (2015-2030)</span>
                            </label>
                        </div>
                        <div class="text-xs text-gray-500 mt-1">
                            <i class="fas fa-info-circle mr-1"></i>
                            Full range may take longer to sync
                        </div>
                    </div>

                    <div class="mt-4">
                        <button id="syncNow" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50" disabled>
                            <i class="fas fa-sync-alt mr-2"></i>
                            Sync Events
                        </button>
                    </div>
                </div>
            </div>

            <!-- Preview Panel -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-xl font-bold flex items-center">
                            <i class="fas fa-eye mr-2 text-green-600"></i>
                            Template Preview
                        </h2>
                        <div class="flex items-center space-x-2">
                            <span class="text-sm text-gray-600">2880 × 2160px</span>
                            <div class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs">
                                reMarkable Pro Move Optimized
                            </div>
                        </div>
                    </div>

                    <!-- Page Navigation -->
                    <div class="flex items-center justify-center mb-4 space-x-2">
                        <button class="page-nav-btn bg-purple-600 text-white px-3 py-1 rounded text-sm hover:bg-purple-700 transition-colors" data-page="0">Week</button>
                        <button class="page-nav-btn bg-gray-300 text-gray-700 px-3 py-1 rounded text-sm hover:bg-gray-400 transition-colors" data-page="1">Mon</button>
                        <button class="page-nav-btn bg-gray-300 text-gray-700 px-3 py-1 rounded text-sm hover:bg-gray-400 transition-colors" data-page="2">Tue</button>
                        <button class="page-nav-btn bg-gray-300 text-gray-700 px-3 py-1 rounded text-sm hover:bg-gray-400 transition-colors" data-page="3">Wed</button>
                        <button class="page-nav-btn bg-gray-300 text-gray-700 px-3 py-1 rounded text-sm hover:bg-gray-400 transition-colors" data-page="4">Thu</button>
                        <button class="page-nav-btn bg-gray-300 text-gray-700 px-3 py-1 rounded text-sm hover:bg-gray-400 transition-colors" data-page="5">Fri</button>
                        <button class="page-nav-btn bg-gray-300 text-gray-700 px-3 py-1 rounded text-sm hover:bg-gray-400 transition-colors" data-page="6">Sat</button>
                        <button class="page-nav-btn bg-gray-300 text-gray-700 px-3 py-1 rounded text-sm hover:bg-gray-400 transition-colors" data-page="7">Sun</button>
                    </div>

                    <!-- Preview Container -->
                    <div class="remarkable-preview eink-optimized p-4">
                        <div id="previewContent">
                            <!-- Franklin Style Weekly Overview -->
                            <div id="weeklyPreview">
                                <!-- Header -->
                                <div class="franklin-section-title mb-3">
                                    WEEKLY PLANNER - <span id="weeklyDateRange">Week of Sep 9, 2025</span>
                                </div>
                                
                                <!-- Franklin Weekly Grid -->
                                <div class="franklin-weekly-grid mb-4">
                                    <!-- Headers Row -->
                                    <div class="franklin-time-header">TIME</div>
                                    <div class="franklin-day-header">MON</div>
                                    <div class="franklin-day-header">TUE</div>
                                    <div class="franklin-day-header">WED</div>
                                    <div class="franklin-day-header">THU</div>
                                    <div class="franklin-day-header">FRI</div>
                                    <div class="franklin-day-header">SAT</div>
                                    <div class="franklin-day-header">SUN</div>
                                    
                                    <!-- 07:00 Row -->
                                    <div class="franklin-time-label">07:00</div>
                                    <div class="franklin-day-cell" id="weekly-mon-7"></div>
                                    <div class="franklin-day-cell" id="weekly-tue-7"></div>
                                    <div class="franklin-day-cell" id="weekly-wed-7"></div>
                                    <div class="franklin-day-cell" id="weekly-thu-7"></div>
                                    <div class="franklin-day-cell" id="weekly-fri-7"></div>
                                    <div class="franklin-day-cell" id="weekly-sat-7"></div>
                                    <div class="franklin-day-cell" id="weekly-sun-7"></div>
                                    
                                    <!-- 08:00 Row -->
                                    <div class="franklin-time-label">08:00</div>
                                    <div class="franklin-day-cell" id="weekly-mon-8"></div>
                                    <div class="franklin-day-cell" id="weekly-tue-8"></div>
                                    <div class="franklin-day-cell" id="weekly-wed-8"></div>
                                    <div class="franklin-day-cell" id="weekly-thu-8"></div>
                                    <div class="franklin-day-cell" id="weekly-fri-8"></div>
                                    <div class="franklin-day-cell" id="weekly-sat-8"></div>
                                    <div class="franklin-day-cell" id="weekly-sun-8"></div>
                                    
                                    <!-- 09:00 Row -->
                                    <div class="franklin-time-label">09:00</div>
                                    <div class="franklin-day-cell" id="weekly-mon-9"></div>
                                    <div class="franklin-day-cell" id="weekly-tue-9"></div>
                                    <div class="franklin-day-cell" id="weekly-wed-9"></div>
                                    <div class="franklin-day-cell" id="weekly-thu-9"></div>
                                    <div class="franklin-day-cell" id="weekly-fri-9"></div>
                                    <div class="franklin-day-cell" id="weekly-sat-9"></div>
                                    <div class="franklin-day-cell" id="weekly-sun-9"></div>
                                    
                                    <!-- 10:00 Row -->
                                    <div class="franklin-time-label">10:00</div>
                                    <div class="franklin-day-cell" id="weekly-mon-10"></div>
                                    <div class="franklin-day-cell" id="weekly-tue-10"></div>
                                    <div class="franklin-day-cell" id="weekly-wed-10"></div>
                                    <div class="franklin-day-cell" id="weekly-thu-10"></div>
                                    <div class="franklin-day-cell" id="weekly-fri-10"></div>
                                    <div class="franklin-day-cell" id="weekly-sat-10"></div>
                                    <div class="franklin-day-cell" id="weekly-sun-10"></div>
                                    
                                    <!-- 11:00 Row -->
                                    <div class="franklin-time-label">11:00</div>
                                    <div class="franklin-day-cell" id="weekly-mon-11"></div>
                                    <div class="franklin-day-cell" id="weekly-tue-11"></div>
                                    <div class="franklin-day-cell" id="weekly-wed-11"></div>
                                    <div class="franklin-day-cell" id="weekly-thu-11"></div>
                                    <div class="franklin-day-cell" id="weekly-fri-11"></div>
                                    <div class="franklin-day-cell" id="weekly-sat-11"></div>
                                    <div class="franklin-day-cell" id="weekly-sun-11"></div>
                                    
                                    <!-- 12:00 Row -->
                                    <div class="franklin-time-label">12:00</div>
                                    <div class="franklin-day-cell" id="weekly-mon-12"></div>
                                    <div class="franklin-day-cell" id="weekly-tue-12"></div>
                                    <div class="franklin-day-cell" id="weekly-wed-12"></div>
                                    <div class="franklin-day-cell" id="weekly-thu-12"></div>
                                    <div class="franklin-day-cell" id="weekly-fri-12"></div>
                                    <div class="franklin-day-cell" id="weekly-sat-12"></div>
                                    <div class="franklin-day-cell" id="weekly-sun-12"></div>
                                    
                                    <!-- 13:00 Row -->
                                    <div class="franklin-time-label">13:00</div>
                                    <div class="franklin-day-cell" id="weekly-mon-13"></div>
                                    <div class="franklin-day-cell" id="weekly-tue-13"></div>
                                    <div class="franklin-day-cell" id="weekly-wed-13"></div>
                                    <div class="franklin-day-cell" id="weekly-thu-13"></div>
                                    <div class="franklin-day-cell" id="weekly-fri-13"></div>
                                    <div class="franklin-day-cell" id="weekly-sat-13"></div>
                                    <div class="franklin-day-cell" id="weekly-sun-13"></div>
                                    
                                    <!-- 14:00 Row -->
                                    <div class="franklin-time-label">14:00</div>
                                    <div class="franklin-day-cell" id="weekly-mon-14"></div>
                                    <div class="franklin-day-cell" id="weekly-tue-14"></div>
                                    <div class="franklin-day-cell" id="weekly-wed-14"></div>
                                    <div class="franklin-day-cell" id="weekly-thu-14"></div>
                                    <div class="franklin-day-cell" id="weekly-fri-14"></div>
                                    <div class="franklin-day-cell" id="weekly-sat-14"></div>
                                    <div class="franklin-day-cell" id="weekly-sun-14"></div>
                                    
                                    <!-- 15:00 Row -->
                                    <div class="franklin-time-label">15:00</div>
                                    <div class="franklin-day-cell" id="weekly-mon-15"></div>
                                    <div class="franklin-day-cell" id="weekly-tue-15"></div>
                                    <div class="franklin-day-cell" id="weekly-wed-15"></div>
                                    <div class="franklin-day-cell" id="weekly-thu-15"></div>
                                    <div class="franklin-day-cell" id="weekly-fri-15"></div>
                                    <div class="franklin-day-cell" id="weekly-sat-15"></div>
                                    <div class="franklin-day-cell" id="weekly-sun-15"></div>
                                    
                                    <!-- 16:00 Row -->
                                    <div class="franklin-time-label">16:00</div>
                                    <div class="franklin-day-cell" id="weekly-mon-16"></div>
                                    <div class="franklin-day-cell" id="weekly-tue-16"></div>
                                    <div class="franklin-day-cell" id="weekly-wed-16"></div>
                                    <div class="franklin-day-cell" id="weekly-thu-16"></div>
                                    <div class="franklin-day-cell" id="weekly-fri-16"></div>
                                    <div class="franklin-day-cell" id="weekly-sat-16"></div>
                                    <div class="franklin-day-cell" id="weekly-sun-16"></div>
                                    
                                    <!-- 17:00 Row -->
                                    <div class="franklin-time-label">17:00</div>
                                    <div class="franklin-day-cell" id="weekly-mon-17"></div>
                                    <div class="franklin-day-cell" id="weekly-tue-17"></div>
                                    <div class="franklin-day-cell" id="weekly-wed-17"></div>
                                    <div class="franklin-day-cell" id="weekly-thu-17"></div>
                                    <div class="franklin-day-cell" id="weekly-fri-17"></div>
                                    <div class="franklin-day-cell" id="weekly-sat-17"></div>
                                    <div class="franklin-day-cell" id="weekly-sun-17"></div>
                                    
                                    <!-- 18:00 Row -->
                                    <div class="franklin-time-label">18:00</div>
                                    <div class="franklin-day-cell" id="weekly-mon-18"></div>
                                    <div class="franklin-day-cell" id="weekly-tue-18"></div>
                                    <div class="franklin-day-cell" id="weekly-wed-18"></div>
                                    <div class="franklin-day-cell" id="weekly-thu-18"></div>
                                    <div class="franklin-day-cell" id="weekly-fri-18"></div>
                                    <div class="franklin-day-cell" id="weekly-sat-18"></div>
                                    <div class="franklin-day-cell" id="weekly-sun-18"></div>
                                    
                                    <!-- 19:00 Row -->
                                    <div class="franklin-time-label">19:00</div>
                                    <div class="franklin-day-cell" id="weekly-mon-19"></div>
                                    <div class="franklin-day-cell" id="weekly-tue-19"></div>
                                    <div class="franklin-day-cell" id="weekly-wed-19"></div>
                                    <div class="franklin-day-cell" id="weekly-thu-19"></div>
                                    <div class="franklin-day-cell" id="weekly-fri-19"></div>
                                    <div class="franklin-day-cell" id="weekly-sat-19"></div>
                                    <div class="franklin-day-cell" id="weekly-sun-19"></div>
                                    
                                    <!-- 20:00 Row -->
                                    <div class="franklin-time-label">20:00</div>
                                    <div class="franklin-day-cell" id="weekly-mon-20"></div>
                                    <div class="franklin-day-cell" id="weekly-tue-20"></div>
                                    <div class="franklin-day-cell" id="weekly-wed-20"></div>
                                    <div class="franklin-day-cell" id="weekly-thu-20"></div>
                                    <div class="franklin-day-cell" id="weekly-fri-20"></div>
                                    <div class="franklin-day-cell" id="weekly-sat-20"></div>
                                    <div class="franklin-day-cell" id="weekly-sun-20"></div>
                                    
                                    <!-- 21:00 Row -->
                                    <div class="franklin-time-label">21:00</div>
                                    <div class="franklin-day-cell" id="weekly-mon-21"></div>
                                    <div class="franklin-day-cell" id="weekly-tue-21"></div>
                                    <div class="franklin-day-cell" id="weekly-wed-21"></div>
                                    <div class="franklin-day-cell" id="weekly-thu-21"></div>
                                    <div class="franklin-day-cell" id="weekly-fri-21"></div>
                                    <div class="franklin-day-cell" id="weekly-sat-21"></div>
                                    <div class="franklin-day-cell" id="weekly-sun-21"></div>
                                    
                                    <!-- 22:00 Row -->
                                    <div class="franklin-time-label">22:00</div>
                                    <div class="franklin-day-cell" id="weekly-mon-22"></div>
                                    <div class="franklin-day-cell" id="weekly-tue-22"></div>
                                    <div class="franklin-day-cell" id="weekly-wed-22"></div>
                                    <div class="franklin-day-cell" id="weekly-thu-22"></div>
                                    <div class="franklin-day-cell" id="weekly-fri-22"></div>
                                    <div class="franklin-day-cell" id="weekly-sat-22"></div>
                                    <div class="franklin-day-cell" id="weekly-sun-22"></div>
                                </div>
                                
                                <!-- Franklin Priority Sections -->
                                <div class="grid grid-cols-3 gap-3">
                                    <div class="franklin-priority-section">
                                        <div class="franklin-section-title">PRIORITY TASKS</div>
                                        <div id="weeklyPriorityTasks" class="text-xs">
                                            □ ___________________<br>
                                            □ ___________________<br>
                                            □ ___________________
                                        </div>
                                    </div>
                                    <div class="franklin-priority-section">
                                        <div class="franklin-section-title">WEEKLY GOALS</div>
                                        <div id="weeklyGoals" class="text-xs">
                                            • ___________________<br>
                                            • ___________________<br>
                                            • ___________________
                                        </div>
                                    </div>
                                    <div class="franklin-priority-section">
                                        <div class="franklin-section-title">STATUS</div>
                                        <div id="weeklyNotes" class="text-xs">
                                            <span id="eventCount">0 events loaded</span><br>
                                            <span id="syncStatus">Ready to sync</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Franklin Style Daily View -->
                            <div id="dailyPreview" class="hidden">
                                <!-- Header -->
                                <div class="franklin-section-title mb-3">
                                    DAILY PLANNER - <span id="dailyDateHeader">Monday, Sep 9, 2025</span>
                                </div>
                                
                                <!-- Franklin Daily Grid -->
                                <div class="franklin-daily-grid">
                                    <!-- Time Column -->
                                    <div class="franklin-daily-time-column">
                                        <div class="franklin-section-title mb-1">TIME</div>
                                        <div class="franklin-daily-time-slot">07:00</div>
                                        <div class="franklin-daily-time-slot">07:30</div>
                                        <div class="franklin-daily-time-slot">08:00</div>
                                        <div class="franklin-daily-time-slot">08:30</div>
                                        <div class="franklin-daily-time-slot">09:00</div>
                                        <div class="franklin-daily-time-slot">09:30</div>
                                        <div class="franklin-daily-time-slot">10:00</div>
                                        <div class="franklin-daily-time-slot">10:30</div>
                                        <div class="franklin-daily-time-slot">11:00</div>
                                        <div class="franklin-daily-time-slot">11:30</div>
                                        <div class="franklin-daily-time-slot">12:00</div>
                                        <div class="franklin-daily-time-slot">12:30</div>
                                        <div class="franklin-daily-time-slot">13:00</div>
                                        <div class="franklin-daily-time-slot">13:30</div>
                                        <div class="franklin-daily-time-slot">14:00</div>
                                        <div class="franklin-daily-time-slot">14:30</div>
                                        <div class="franklin-daily-time-slot">15:00</div>
                                        <div class="franklin-daily-time-slot">15:30</div>
                                        <div class="franklin-daily-time-slot">16:00</div>
                                        <div class="franklin-daily-time-slot">16:30</div>
                                        <div class="franklin-daily-time-slot">17:00</div>
                                        <div class="franklin-daily-time-slot">17:30</div>
                                        <div class="franklin-daily-time-slot">18:00</div>
                                        <div class="franklin-daily-time-slot">18:30</div>
                                        <div class="franklin-daily-time-slot">19:00</div>
                                        <div class="franklin-daily-time-slot">19:30</div>
                                        <div class="franklin-daily-time-slot">20:00</div>
                                        <div class="franklin-daily-time-slot">20:30</div>
                                        <div class="franklin-daily-time-slot">21:00</div>
                                        <div class="franklin-daily-time-slot">21:30</div>
                                        <div class="franklin-daily-time-slot">22:00</div>
                                    </div>
                                    
                                    <!-- Schedule Column -->
                                    <div>
                                        <div class="franklin-section-title mb-1">APPOINTMENTS & TASKS</div>
                                        <div id="dailySchedule">
                                            <div class="franklin-daily-schedule-slot" id="daily-7-0"></div>
                                            <div class="franklin-daily-schedule-slot" id="daily-7-30"></div>
                                            <div class="franklin-daily-schedule-slot" id="daily-8-0"></div>
                                            <div class="franklin-daily-schedule-slot" id="daily-8-30"></div>
                                            <div class="franklin-daily-schedule-slot" id="daily-9-0"></div>
                                            <div class="franklin-daily-schedule-slot" id="daily-9-30"></div>
                                            <div class="franklin-daily-schedule-slot" id="daily-10-0"></div>
                                            <div class="franklin-daily-schedule-slot" id="daily-10-30"></div>
                                            <div class="franklin-daily-schedule-slot" id="daily-11-0"></div>
                                            <div class="franklin-daily-schedule-slot" id="daily-11-30"></div>
                                            <div class="franklin-daily-schedule-slot" id="daily-12-0"></div>
                                            <div class="franklin-daily-schedule-slot" id="daily-12-30"></div>
                                            <div class="franklin-daily-schedule-slot" id="daily-13-0"></div>
                                            <div class="franklin-daily-schedule-slot" id="daily-13-30"></div>
                                            <div class="franklin-daily-schedule-slot" id="daily-14-0"></div>
                                            <div class="franklin-daily-schedule-slot" id="daily-14-30"></div>
                                            <div class="franklin-daily-schedule-slot" id="daily-15-0"></div>
                                            <div class="franklin-daily-schedule-slot" id="daily-15-30"></div>
                                            <div class="franklin-daily-schedule-slot" id="daily-16-0"></div>
                                            <div class="franklin-daily-schedule-slot" id="daily-16-30"></div>
                                            <div class="franklin-daily-schedule-slot" id="daily-17-0"></div>
                                            <div class="franklin-daily-schedule-slot" id="daily-17-30"></div>
                                            <div class="franklin-daily-schedule-slot" id="daily-18-0"></div>
                                            <div class="franklin-daily-schedule-slot" id="daily-18-30"></div>
                                            <div class="franklin-daily-schedule-slot" id="daily-19-0"></div>
                                            <div class="franklin-daily-schedule-slot" id="daily-19-30"></div>
                                            <div class="franklin-daily-schedule-slot" id="daily-20-0"></div>
                                            <div class="franklin-daily-schedule-slot" id="daily-20-30"></div>
                                            <div class="franklin-daily-schedule-slot" id="daily-21-0"></div>
                                            <div class="franklin-daily-schedule-slot" id="daily-21-30"></div>
                                            <div class="franklin-daily-schedule-slot" id="daily-22-0"></div>
                                        </div>
                                    </div>
                                    
                                    <!-- Franklin Priority Sidebar -->
                                    <div>
                                        <div class="franklin-priority-section mb-2">
                                            <div class="franklin-section-title">DAILY GOALS</div>
                                            <div id="dailyGoals" class="text-xs">
                                                □ _______________<br>
                                                □ _______________<br>
                                                □ _______________
                                            </div>
                                        </div>
                                        
                                        <div class="franklin-priority-section mb-2">
                                            <div class="franklin-section-title">PRIORITIES</div>
                                            <div id="dailyPriorities" class="text-xs">
                                                A) _______________<br>
                                                B) _______________<br>
                                                C) _______________
                                            </div>
                                        </div>
                                        
                                        <div class="franklin-priority-section mb-2">
                                            <div class="franklin-section-title">NOTES</div>
                                            <div id="dailyNotes" class="text-xs">
                                                <div id="dayOverview">Sync calendars to see events</div>
                                            </div>
                                        </div>
                                        
                                        <div class="franklin-priority-section">
                                            <div class="franklin-section-title">TODAY'S EVENTS</div>
                                            <div id="todaysEvents" class="text-xs">
                                                No events synced yet
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Export Actions -->
                    <div class="mt-6 flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <div class="text-sm text-gray-600">
                                <i class="fas fa-info-circle mr-1"></i>
                                8 pages • PDF format • Google sync enabled
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button id="generatePDF" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors">
                                <i class="fas fa-download mr-2"></i>
                                Generate PDF
                            </button>
                            <button id="deployToReplit" class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition-colors">
                                <i class="fas fa-rocket mr-2"></i>
                                Deploy to Replit
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Bar -->
        <div class="mt-8 bg-white rounded-xl shadow-lg p-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <div class="w-3 h-3 bg-green-400 rounded-full"></div>
                        <span class="text-sm text-gray-600">Template Ready</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="w-3 h-3 bg-blue-400 rounded-full"></div>
                        <span class="text-sm text-gray-600">Google Calendar: <span id="calendarStatus">Disconnected</span></span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="w-3 h-3 bg-yellow-400 rounded-full"></div>
                        <span class="text-sm text-gray-600">Export: Ready</span>
                    </div>
                </div>
                <div class="text-sm text-gray-500">
                    Last updated: <span id="lastUpdate">Never</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let gapi_loaded = false;
        let isSignedIn = false;
        let currentPage = 0;
        let calendarEvents = [];
        let tokenClient = null;
        let accessToken = null;

        // Initialize Backend API (Server-side OAuth)
        async function initializeGapi() {
            console.log('Starting backend API initialization...');
            
            try {
                // Load the backend config first
                const response = await fetch('/config.js');
                if (!response.ok) {
                    throw new Error('Failed to load config');
                }
                const configText = await response.text();
                eval(configText); // Load backend config
                
                console.log('Backend config loaded:', window.BACKEND_CONFIG);
                gapi_loaded = true;
                
                // Check authentication status
                await checkAuthStatus();
                
                // Enable auth button after successful initialization
                const authButton = document.getElementById('authButton');
                authButton.disabled = false;
                if (!isSignedIn) {
                    authButton.innerHTML = '<i class="fab fa-google mr-2"></i>Connect Google';
                }
                
            } catch (error) {
                console.error('Failed to initialize backend API:', error);
                const authButton = document.getElementById('authButton');
                authButton.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i>Connection Error';
                authButton.disabled = false;
                // Try again in a few seconds
                setTimeout(initializeGapi, 3000);
            }
        }
        
        // Check authentication status with backend
        async function checkAuthStatus() {
            try {
                const response = await fetch('/auth/status');
                const data = await response.json();
                
                isSignedIn = data.authenticated;
                console.log('Auth status:', isSignedIn ? 'authenticated' : 'not authenticated');
                
                updateAuthUI();
                
                // Load calendars if authenticated
                if (isSignedIn) {
                    loadCalendars();
                }
                
            } catch (error) {
                console.error('Error checking auth status:', error);
                isSignedIn = false;
                updateAuthUI();
            }
        }

        // Update authentication UI
        function updateAuthUI() {
            const authButton = document.getElementById('authButton');
            const authStatus = document.getElementById('authStatus');
            const syncIndicator = document.getElementById('syncIndicator');
            const syncButton = document.getElementById('syncNow');
            const calendarStatus = document.getElementById('calendarStatus');

            if (isSignedIn) {
                authButton.innerHTML = '<i class="fas fa-sign-out-alt mr-2"></i>Disconnect';
                authStatus.querySelector('span').textContent = 'Connected';
                syncIndicator.className = 'sync-indicator bg-green-400';
                syncButton.disabled = false;
                calendarStatus.textContent = 'Connected';
                loadCalendars();
            } else {
                authButton.innerHTML = '<i class="fab fa-google mr-2"></i>Connect Google';
                authStatus.querySelector('span').textContent = 'Not Connected';
                syncIndicator.className = 'sync-indicator bg-yellow-400';
                syncButton.disabled = true;
                calendarStatus.textContent = 'Disconnected';
            }
        }

        // Handle authentication (Server-side OAuth)
        function handleAuth() {
            console.log('=== AUTH BUTTON CLICKED ===');
            console.log('gapi_loaded:', gapi_loaded);
            console.log('isSignedIn:', isSignedIn);
            
            if (!gapi_loaded) {
                console.error('Backend API not ready yet');
                alert('Backend is still loading. Please try again in a moment.');
                return;
            }
            
            if (isSignedIn) {
                console.log('Logging out...');
                fetch('/auth/logout', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Logout successful:', data);
                        isSignedIn = false;
                        updateAuthUI();
                        
                        // Clear calendar list
                        const calendarListEl = document.getElementById('calendarList');
                        calendarListEl.innerHTML = '<div class="text-gray-500 text-center py-4">Connect Google Calendar to sync events</div>';
                    })
                    .catch(error => {
                        console.error('Logout error:', error);
                        alert('Error logging out: ' + error.message);
                    });
            } else {
                console.log('=== STARTING SERVER-SIDE OAUTH FLOW ===');
                // Redirect to server-side OAuth endpoint
                window.location.href = '/auth/google';
            }
        }

        // Load user calendars (Server-side)
        async function loadCalendars() {
            try {
                const response = await fetch('/api/calendars');
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to load calendars');
                }
                
                const calendars = data.calendars;
                console.log('Found calendars:', calendars.length);
                calendars.forEach(cal => console.log(`Calendar: ${cal.summary} (${cal.id}) - Primary: ${cal.primary}`));

                const calendarListEl = document.getElementById('calendarList');
                calendarListEl.innerHTML = calendars.map(calendar => {
                    const isMainCalendar = calendar.primary || calendar.id.includes('@gmail.com');
                    return `
                        <label class="flex items-center space-x-2 p-2 hover:bg-gray-50 rounded border ${isMainCalendar ? 'border-blue-200 bg-blue-50' : 'border-gray-200'}">
                            <input type="checkbox" class="calendar-checkbox" data-calendar-id="${calendar.id}" ${calendar.primary ? 'checked' : ''}>
                            <div class="w-4 h-4 rounded" style="background-color: ${calendar.backgroundColor || '#3b82f6'}"></div>
                            <div class="flex flex-col">
                                <span class="text-sm font-medium">${calendar.summary}</span>
                                <span class="text-xs text-gray-500">${calendar.accessRole || 'reader'} ${isMainCalendar ? '(Main)' : ''}</span>
                            </div>
                        </label>
                    `;
                }).join('');

                // Update status
                const calendarStatus = document.getElementById('calendarStatus');
                calendarStatus.textContent = `${calendars.length} calendars found`;

            } catch (error) {
                console.error('Error loading calendars:', error);
                const calendarListEl = document.getElementById('calendarList');
                calendarListEl.innerHTML = `
                    <div class="text-red-500 text-center py-4">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        Error loading calendars: ${error.message}
                    </div>
                `;
            }
        }

        // Sync calendar events (Server-side)
        async function syncCalendarEvents() {
            if (!isSignedIn) return;

            const selectedCalendars = Array.from(document.querySelectorAll('.calendar-checkbox:checked'))
                .map(cb => cb.dataset.calendarId);

            if (selectedCalendars.length === 0) {
                alert('Please select at least one calendar to sync');
                return;
            }

            // Check sync range option
            const syncRange = document.querySelector('input[name="syncRange"]:checked')?.value || 'week';
            const isFullRange = syncRange === 'full';

            const weekStart = document.getElementById('weekStart').value;
            
            calendarEvents = [];

            try {
                // Show loading state
                const syncButton = document.getElementById('syncNow');
                const originalText = syncButton.innerHTML;
                syncButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Syncing...';
                syncButton.disabled = true;

                // Build query parameters
                const params = new URLSearchParams();
                selectedCalendars.forEach(id => params.append('calendar_ids', id));
                
                if (isFullRange) {
                    // Full range (2015-2030)
                    params.append('full_range', 'true');
                    console.log('🗓️ Loading events from 2015-2030 (this may take a moment)...');
                } else {
                    // Weekly range
                    if (!weekStart) {
                        alert('Please select a week start date');
                        syncButton.innerHTML = originalText;
                        syncButton.disabled = false;
                        return;
                    }
                    const startDate = new Date(weekStart);
                    const endDate = new Date(startDate);
                    endDate.setDate(endDate.getDate() + 7);
                    params.append('time_min', startDate.toISOString());
                    params.append('time_max', endDate.toISOString());
                }

                const response = await fetch(`/api/events?${params.toString()}`);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to fetch events');
                }
                
                calendarEvents = data.events || [];
                const range = data.date_range || 'selected period';
                console.log(`📋 Synced ${calendarEvents.length} events from ${selectedCalendars.length} calendars (${range})`);
                
                // Update UI with success message
                console.log(`✅ Successfully synced ${calendarEvents.length} events from ${range}!`);
                
                // Show success notification
                const notification = document.createElement('div');
                notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
                notification.innerHTML = `<i class="fas fa-check-circle mr-2"></i>Synced ${calendarEvents.length} events from ${range}`;
                document.body.appendChild(notification);
                setTimeout(() => notification.remove(), 5000);
                
                // Restore button
                syncButton.innerHTML = originalText;
                syncButton.disabled = false;
                
            } catch (error) {
                console.error('Error fetching events:', error);
                alert('Failed to sync calendar events: ' + error.message);
                
                // Restore button on error
                const syncButton = document.getElementById('syncNow');
                syncButton.innerHTML = '<i class="fas fa-sync-alt mr-2"></i>Sync Calendar Events';
                syncButton.disabled = false;
            }

            updateLastUpdateTime();
            refreshPreview();
        }

        // Update preview based on current page
        function refreshPreview() {
            // Update the preview with real calendar events
            if (calendarEvents && calendarEvents.length > 0) {
                console.log(`Refreshing preview with ${calendarEvents.length} calendar events`);
                updateEventsSummary();
                updateDailyView();
                updateEventCount();
            } else {
                clearPreviewData();
            }
            updateLastUpdateTime();
        }
        
        // Update Franklin style weekly view with events
        function updateEventsSummary() {
            if (!calendarEvents || calendarEvents.length === 0) {
                console.log('⚠️ No calendar events available for weekly view');
                return;
            }
            
            // Get current week range
            const weekStartInput = document.getElementById('weekStart');
            const weekStart = weekStartInput ? new Date(weekStartInput.value) : new Date();
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekEnd.getDate() + 7);
            
            // Update week range header
            const weekRangeEl = document.getElementById('weeklyDateRange');
            if (weekRangeEl) {
                const options = { month: 'short', day: 'numeric', year: 'numeric' };
                weekRangeEl.textContent = `Week of ${weekStart.toLocaleDateString('en-US', options)}`;
            }
            
            // Clear all day cells first (all hours from 7 to 22)
            const days = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
            for (let hour = 7; hour <= 22; hour++) {
                days.forEach(day => {
                    const cell = document.getElementById(`weekly-${day}-${hour}`);
                    if (cell) cell.innerHTML = '';
                });
            }
            
            // Filter events for current week
            const weekEvents = calendarEvents.filter(event => {
                if (!event.start) return false;
                const eventDate = new Date(event.start.dateTime || event.start.date);
                return eventDate >= weekStart && eventDate < weekEnd;
            });
            
            console.log(`📅 Displaying ${weekEvents.length} events in weekly view for week of ${weekStart.toDateString()}`);
            
            // Place events in appropriate time/day cells
            weekEvents.forEach(event => {
                const eventDate = new Date(event.start.dateTime || event.start.date);
                const dayOfWeek = eventDate.getDay(); // 0 = Sunday, 1 = Monday, etc.
                const hour = event.start.dateTime ? eventDate.getHours() : 9; // Default to 9am for all-day events
                
                // Map day of week to our day names (corrected for grid layout)
                const dayNames = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
                const dayName = dayNames[dayOfWeek];
                
                // Use exact hour for placement (within 7-22 range)
                let timeSlot = hour;
                if (hour < 7) timeSlot = 7;
                if (hour > 22) timeSlot = 22;
                
                const cellId = `weekly-${dayName}-${timeSlot}`;
                const cell = document.getElementById(cellId);
                
                console.log(`📍 Event "${event.summary}" on ${eventDate.toDateString()} (${dayName}) at ${hour}:00 -> ${cellId}`);
                
                if (cell) {
                    const eventEl = document.createElement('div');
                    eventEl.className = 'franklin-event';
                    const startTime = event.start.dateTime ? 
                        eventDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : 
                        '';
                    eventEl.textContent = event.summary || 'Event';
                    eventEl.title = `${startTime} ${event.summary || 'Event'}\nClick to view day details`;
                    
                    // Add click handler for bidirectional navigation to daily view
                    eventEl.addEventListener('click', (e) => {
                        e.stopPropagation();
                        console.log(`🔗 Navigating from weekly to daily view for: ${event.summary}`);
                        navigateToDay(eventDate);
                    });
                    
                    // Store event data for reference
                    eventEl.dataset.eventDate = eventDate.toISOString();
                    eventEl.dataset.eventSummary = event.summary || 'Event';
                    
                    cell.appendChild(eventEl);
                } else {
                    console.log(`⚠️ Could not find cell ${cellId} for event "${event.summary}"`);
                }
            });
        }
        
        // Update Franklin style daily view with events
        function updateDailyView() {
            if (!calendarEvents || calendarEvents.length === 0) {
                console.log('⚠️ No calendar events available for daily view');
                return;
            }
            
            // Get the current page (day) we're viewing
            const currentDayIndex = currentPage - 1; // Pages 1-7 are Mon-Sun
            if (currentDayIndex < 0 || currentDayIndex > 6) return;
            
            // Get current week range
            const weekStartInput = document.getElementById('weekStart');
            const weekStart = weekStartInput ? new Date(weekStartInput.value) : new Date();
            
            // Calculate the specific day
            const targetDay = new Date(weekStart);
            targetDay.setDate(weekStart.getDate() + currentDayIndex);
            
            // Update daily header
            const dailyHeaderEl = document.getElementById('dailyDateHeader');
            if (dailyHeaderEl) {
                const options = { weekday: 'long', month: 'short', day: 'numeric', year: 'numeric' };
                dailyHeaderEl.textContent = targetDay.toLocaleDateString('en-US', options);
            }
            
            // Clear all time slots first (30-minute intervals from 07:00 to 22:00)
            for (let hour = 7; hour <= 22; hour++) {
                for (let minute = 0; minute <= 30; minute += 30) {
                    if (hour === 22 && minute === 30) break; // End at 22:00
                    const slot = document.getElementById(`daily-${hour}-${minute}`);
                    if (slot) slot.innerHTML = '';
                }
            }
            
            // Filter events for this specific day
            const dayEvents = calendarEvents.filter(event => {
                if (!event.start) return false;
                const eventDate = new Date(event.start.dateTime || event.start.date);
                return eventDate.toDateString() === targetDay.toDateString();
            });
            
            console.log(`📅 Daily view for ${targetDay.toDateString()}: ${dayEvents.length} events found`);
            if (dayEvents.length > 0) {
                console.log('Day events:', dayEvents.map(e => `${e.summary} at ${new Date(e.start.dateTime || e.start.date).toLocaleTimeString()}`));
            }
            
            // Place events in 30-minute time slots
            dayEvents.forEach(event => {
                const eventDate = new Date(event.start.dateTime || event.start.date);
                const hour = eventDate.getHours();
                const minute = eventDate.getMinutes();
                
                // Only show events within our time range (07:00 - 22:00)
                if (hour >= 7 && hour <= 22) {
                    // Round to nearest 30-minute slot
                    const slotMinute = minute < 30 ? 0 : 30;
                    const slotId = `daily-${hour}-${slotMinute}`;
                    const slot = document.getElementById(slotId);
                    
                    if (slot) {
                        const eventEl = document.createElement('div');
                        eventEl.className = 'franklin-event';
                        const time = event.start.dateTime ? 
                            eventDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : 
                            'All day';
                        eventEl.innerHTML = `<strong>${time}</strong><br><span style="font-size: 7px;">${event.summary || 'Untitled Event'}</span>`;
                        eventEl.title = `${event.summary || 'Event'}\nClick to return to weekly view`;
                        
                        // Add click handler to go back to weekly view
                        eventEl.addEventListener('click', (e) => {
                            e.stopPropagation();
                            console.log(`🔗 Returning to weekly view from daily event: ${event.summary}`);
                            switchPage(0); // Return to weekly view
                        });
                        
                        // Store event data
                        eventEl.dataset.eventDate = eventDate.toISOString();
                        eventEl.dataset.eventSummary = event.summary || 'Event';
                        
                        slot.appendChild(eventEl);
                        console.log(`📌 Placed event "${event.summary}" at ${slotId}`);
                    } else {
                        console.log(`⚠️ Could not find slot ${slotId} for event "${event.summary}"`);
                    }
                } else {
                    console.log(`⚠️ Event "${event.summary}" at ${hour}:${minute} is outside time range (07:00-22:00)`);
                }
            });
            
            // Update day overview
            const overviewEl = document.getElementById('dayOverview');
            if (overviewEl) {
                overviewEl.innerHTML = `${dayEvents.length} events scheduled<br>${calendarEvents.length} total synced`;
            }
            
            // Update today's events list in sidebar
            const todaysEl = document.getElementById('todaysEvents');
            if (todaysEl) {
                if (dayEvents.length === 0) {
                    todaysEl.innerHTML = 'No events scheduled';
                } else {
                    const eventsList = dayEvents.slice(0, 3).map(event => {
                        const startTime = event.start.dateTime ? 
                            new Date(event.start.dateTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : 
                            'All day';
                        return `${startTime}<br>${event.summary || 'Event'}`;
                    }).join('<br>---<br>');
                    todaysEl.innerHTML = eventsList;
                    
                    if (dayEvents.length > 3) {
                        todaysEl.innerHTML += `<br>... +${dayEvents.length - 3} more`;
                    }
                }
            }
        }
        
        // Update event count display
        function updateEventCount() {
            const countEl = document.getElementById('eventCount');
            const statusEl = document.getElementById('syncStatus');
            
            if (!calendarEvents || calendarEvents.length === 0) {
                if (countEl) countEl.textContent = '0 events loaded';
                if (statusEl) statusEl.textContent = 'Ready to sync';
                return;
            }
            
            // Get current week range
            const weekStartInput = document.getElementById('weekStart');
            const weekStart = weekStartInput ? new Date(weekStartInput.value) : new Date();
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekEnd.getDate() + 7);
            
            // Filter events for current week
            const weekEvents = calendarEvents.filter(event => {
                if (!event.start) return false;
                const eventDate = new Date(event.start.dateTime || event.start.date);
                return eventDate >= weekStart && eventDate < weekEnd;
            });
            
            if (countEl) {
                countEl.textContent = `${weekEvents.length} events this week (${calendarEvents.length} total)`;
            }
            
            if (statusEl) {
                statusEl.textContent = `✓ Synced successfully`;
            }
        }
        
        // Clear preview data when no events
        function clearPreviewData() {
            const summaryEl = document.getElementById('weeklyEventsSummary');
            if (summaryEl) summaryEl.innerHTML = '<div>Select calendars and sync to see your events</div>';
            
            const overviewEl = document.getElementById('dayOverview');
            if (overviewEl) overviewEl.textContent = 'Sync calendars to see today\'s focus';
            
            const todaysEl = document.getElementById('todaysEvents');
            if (todaysEl) todaysEl.innerHTML = '<div>No events synced yet</div>';
        }

        // Switch preview pages with optional target date
        function switchPage(pageIndex, targetDate = null) {
            // If targetDate provided, calculate the appropriate page index
            if (targetDate) {
                const weekStartInput = document.getElementById('weekStart');
                if (weekStartInput) {
                    // Calculate the Monday of the week containing targetDate
                    const date = new Date(targetDate);
                    const day = date.getDay();
                    const diff = date.getDate() - day + (day === 0 ? -6 : 1); // adjust when day is Sunday
                    const monday = new Date(date.setDate(diff));
                    
                    // Update week start if different
                    const currentWeekStart = new Date(weekStartInput.value);
                    if (monday.toDateString() !== currentWeekStart.toDateString()) {
                        weekStartInput.value = monday.toISOString().split('T')[0];
                        refreshPreview(); // Reload events for new week
                    }
                    
                    // Calculate which day of the week this is (1-7 for Mon-Sun)
                    const targetDay = new Date(targetDate).getDay();
                    pageIndex = targetDay === 0 ? 7 : targetDay; // Sunday = 7, Mon = 1, etc.
                }
            }
            
            currentPage = pageIndex;

            // Update navigation buttons
            document.querySelectorAll('.page-nav-btn').forEach((btn, index) => {
                if (index === pageIndex) {
                    btn.className = 'page-nav-btn bg-purple-600 text-white px-3 py-1 rounded text-sm hover:bg-purple-700 transition-colors';
                } else {
                    btn.className = 'page-nav-btn bg-gray-300 text-gray-700 px-3 py-1 rounded text-sm hover:bg-gray-400 transition-colors';
                }
            });

            // Show/hide preview content
            const weeklyPreview = document.getElementById('weeklyPreview');
            const dailyPreview = document.getElementById('dailyPreview');

            if (pageIndex === 0) {
                weeklyPreview.classList.remove('hidden');
                dailyPreview.classList.add('hidden');
                updateEventsSummary(); // Refresh weekly view
            } else {
                weeklyPreview.classList.add('hidden');
                dailyPreview.classList.remove('hidden');
                updateDailyView(); // Refresh daily view

                // Update daily preview for selected day
                const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
                const dayName = days[pageIndex - 1];
                
                // Get actual date from selected week
                const weekStart = document.getElementById('weekStart').value;
                if (weekStart) {
                    const startDate = new Date(weekStart);
                    const dayDate = new Date(startDate);
                    dayDate.setDate(startDate.getDate() + (pageIndex - 1));
                    
                    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                    dailyPreview.querySelector('h3').textContent = dayDate.toLocaleDateString('en-US', options);
                } else {
                    dailyPreview.querySelector('h3').textContent = `${dayName} - Select week start date`;
                }
            }
        }
        
        // Navigate to specific day from event click
        function navigateToDay(eventDate) {
            const date = new Date(eventDate);
            console.log(`🔗 Navigating to daily view for ${date.toDateString()}`);
            switchPage(0, date); // This will calculate the correct day and switch to it
        }

        // Generate PDF
        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'landscape',
                unit: 'px',
                format: [2880, 2160]
            });

            // This is a simplified PDF generation
            // In a real implementation, you would render each page with proper layout
            for (let page = 0; page < 8; page++) {
                if (page > 0) doc.addPage();

                doc.setFontSize(24);
                if (page === 0) {
                    doc.text('reMarkable Pro Move - Weekly Overview', 100, 100);
                } else {
                    const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
                    doc.text(`reMarkable Pro Move - ${days[page - 1]}`, 100, 100);
                }

                // Add grid lines and template structure
                doc.setDrawColor(128, 128, 128);
                doc.setLineWidth(1);

                // Draw basic grid structure
                for (let i = 0; i < 24; i++) {
                    const y = 200 + (i * 60);
                    doc.line(50, y, 2800, y);
                    doc.text(`${i.toString().padStart(2, '0')}:00`, 20, y + 15);
                }

                // Add vertical lines for time blocks
                for (let i = 0; i < 7; i++) {
                    const x = 300 + (i * 350);
                    doc.line(x, 150, x, 2000);
                }
            }

            const weekStart = document.getElementById('weekStart').value || new Date().toISOString().split('T')[0];
            doc.save(`remarkable_calendar_${weekStart}.pdf`);

            updateLastUpdateTime();
        }

        // Deploy to Replit
        function deployToReplit() {
            // Check if we have calendars and events synced
            if (!isSignedIn) {
                alert('Please connect your Google Calendar first before deploying.');
                return;
            }
            
            const selectedCalendars = Array.from(document.querySelectorAll('.calendar-checkbox:checked'));
            if (selectedCalendars.length === 0) {
                alert('Please select at least one calendar to sync before deploying.');
                return;
            }
            
            // This application is already deployed on Replit and ready to use
            alert('Your reMarkable Calendar Generator is ready! All your calendar data is securely stored and synced. You can now generate PDF templates for your reMarkable device.');
        }

        // Update last update time
        function updateLastUpdateTime() {
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        }

        // Initialize date input with current week
        function initializeDateInput() {
            const today = new Date();
            const monday = new Date(today);
            monday.setDate(today.getDate() - today.getDay() + 1);
            document.getElementById('weekStart').value = monday.toISOString().split('T')[0];
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            initializeDateInput();
            updateLastUpdateTime();

            // Auth button
            document.getElementById('authButton').addEventListener('click', handleAuth);

            // Sync button
            document.getElementById('syncNow').addEventListener('click', syncCalendarEvents);

            // Page navigation
            document.querySelectorAll('.page-nav-btn').forEach((btn, index) => {
                btn.addEventListener('click', () => switchPage(index));
            });

            // Generate PDF button
            document.getElementById('generatePDF').addEventListener('click', generatePDF);

            // Deploy button
            document.getElementById('deployToReplit').addEventListener('click', deployToReplit);

            // Configuration changes
            document.getElementById('weekStart').addEventListener('change', () => {
                console.log('📅 Week changed, refreshing preview...');
                refreshPreview();
            });
            document.getElementById('timeFormat').addEventListener('change', refreshPreview);
            document.getElementById('showHabits').addEventListener('change', refreshPreview);
            document.getElementById('showDecisions').addEventListener('change', refreshPreview);
            document.getElementById('showEnergy').addEventListener('change', refreshPreview);

            // Theme selection
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.theme-btn').forEach(b => 
                        b.classList.remove('border-purple-500'));
                    e.target.closest('.theme-btn').classList.add('border-purple-500');
                    refreshPreview();
                });
            });

            // Set default theme
            document.querySelector('.theme-btn[data-theme="sage"]').classList.add('border-purple-500');

            // Show loading state initially
            const authButton = document.getElementById('authButton');
            authButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Loading...';
            authButton.disabled = true;

            // Initialize Google API when page loads (after a delay to ensure all resources are loaded)
            setTimeout(initializeGapi, 1000);
            
            // Check for OAuth success parameter in URL
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('auth') === 'success') {
                console.log('🎉 OAuth success detected! Refreshing auth status...');
                // Remove the parameter from URL
                window.history.replaceState({}, document.title, window.location.pathname);
                // Force refresh auth status after OAuth success
                setTimeout(() => {
                    checkAuthStatus();
                }, 500);
            }
        });
    </script>
</body>
</html>