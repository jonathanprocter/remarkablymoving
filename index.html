<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>reMarkable Pro Move Calendar Generator</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="config.js"></script>
    <style>
        .remarkable-preview {
            aspect-ratio: 4/3;
            background: linear-gradient(145deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px solid #dee2e6;
            border-radius: 12px;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #dee2e6;
        }
        .time-slot {
            min-height: 40px;
            border-bottom: 1px dotted #adb5bd;
        }
        .sync-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .eink-optimized {
            filter: contrast(1.2) brightness(1.1);
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <i class="fas fa-calendar-alt text-3xl"></i>
                    <div>
                        <h1 class="text-2xl font-bold">reMarkable Pro Move Calendar Generator</h1>
                        <p class="text-blue-100">Professional calendar templates with Google Calendar sync</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="authStatus" class="flex items-center space-x-2">
                        <div class="sync-indicator bg-yellow-400" id="syncIndicator"></div>
                        <span class="text-sm">Not Connected</span>
                    </div>
                    <button id="authButton" class="bg-white text-purple-600 px-4 py-2 rounded-lg hover:bg-gray-100 transition-colors">
                        <i class="fab fa-google mr-2"></i>Connect Google
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container mx-auto px-6 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <!-- Configuration Panel -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                    <h2 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-cog mr-2 text-purple-600"></i>
                        Template Configuration
                    </h2>

                    <!-- Week Selection -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Week Starting</label>
                        <input type="date" id="weekStart" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>

                    <!-- Color Theme -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">E-ink Optimization</label>
                        <div class="grid grid-cols-2 gap-2">
                            <button class="theme-btn p-3 border-2 border-gray-300 rounded-lg text-center hover:border-purple-500 transition-colors" data-theme="sage">
                                <div class="w-full h-4 bg-gradient-to-r from-gray-300 to-gray-500 rounded mb-1"></div>
                                <span class="text-xs">Sage Green</span>
                            </button>
                            <button class="theme-btn p-3 border-2 border-gray-300 rounded-lg text-center hover:border-purple-500 transition-colors" data-theme="classic">
                                <div class="w-full h-4 bg-gradient-to-r from-gray-400 to-gray-600 rounded mb-1"></div>
                                <span class="text-xs">Classic</span>
                            </button>
                        </div>
                    </div>

                    <!-- Layout Options -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Layout Settings</label>
                        <div class="space-y-2">
                            <label class="flex items-center">
                                <input type="checkbox" id="showHabits" class="mr-2" checked>
                                <span class="text-sm">Include Habit Tracker</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="showDecisions" class="mr-2" checked>
                                <span class="text-sm">Decision Framework</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="showEnergy" class="mr-2" checked>
                                <span class="text-sm">Energy Tracker</span>
                            </label>
                        </div>
                    </div>

                    <!-- Time Format -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Time Format</label>
                        <select id="timeFormat" class="w-full p-2 border border-gray-300 rounded-lg">
                            <option value="24">24-hour</option>
                            <option value="12">12-hour</option>
                        </select>
                    </div>
                </div>

                <!-- Google Calendar Integration -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fab fa-google mr-2 text-blue-600"></i>
                        Calendar Integration
                    </h2>

                    <div id="calendarList" class="space-y-2">
                        <div class="text-gray-500 text-center py-4">
                            Connect Google Calendar to sync events
                        </div>
                    </div>

                    <!-- Sync Range Options -->
                    <div class="mt-4 mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Sync Range</label>
                        <div class="space-y-2">
                            <label class="flex items-center">
                                <input type="radio" name="syncRange" value="week" class="mr-2" checked>
                                <span class="text-sm">Current Week</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="syncRange" value="full" class="mr-2">
                                <span class="text-sm font-bold text-purple-600">Full Range (2015-2030)</span>
                            </label>
                        </div>
                        <div class="text-xs text-gray-500 mt-1">
                            <i class="fas fa-info-circle mr-1"></i>
                            Full range may take longer to sync
                        </div>
                    </div>

                    <div class="mt-4">
                        <button id="syncNow" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50" disabled>
                            <i class="fas fa-sync-alt mr-2"></i>
                            Sync Events
                        </button>
                    </div>
                </div>
            </div>

            <!-- Preview Panel -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-xl font-bold flex items-center">
                            <i class="fas fa-eye mr-2 text-green-600"></i>
                            Template Preview
                        </h2>
                        <div class="flex items-center space-x-2">
                            <span class="text-sm text-gray-600">2880 √ó 2160px</span>
                            <div class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs">
                                reMarkable Pro Move Optimized
                            </div>
                        </div>
                    </div>

                    <!-- Page Navigation -->
                    <div class="flex items-center justify-center mb-4 space-x-2">
                        <button class="page-nav-btn bg-purple-600 text-white px-3 py-1 rounded text-sm hover:bg-purple-700 transition-colors" data-page="0">Week</button>
                        <button class="page-nav-btn bg-gray-300 text-gray-700 px-3 py-1 rounded text-sm hover:bg-gray-400 transition-colors" data-page="1">Mon</button>
                        <button class="page-nav-btn bg-gray-300 text-gray-700 px-3 py-1 rounded text-sm hover:bg-gray-400 transition-colors" data-page="2">Tue</button>
                        <button class="page-nav-btn bg-gray-300 text-gray-700 px-3 py-1 rounded text-sm hover:bg-gray-400 transition-colors" data-page="3">Wed</button>
                        <button class="page-nav-btn bg-gray-300 text-gray-700 px-3 py-1 rounded text-sm hover:bg-gray-400 transition-colors" data-page="4">Thu</button>
                        <button class="page-nav-btn bg-gray-300 text-gray-700 px-3 py-1 rounded text-sm hover:bg-gray-400 transition-colors" data-page="5">Fri</button>
                        <button class="page-nav-btn bg-gray-300 text-gray-700 px-3 py-1 rounded text-sm hover:bg-gray-400 transition-colors" data-page="6">Sat</button>
                        <button class="page-nav-btn bg-gray-300 text-gray-700 px-3 py-1 rounded text-sm hover:bg-gray-400 transition-colors" data-page="7">Sun</button>
                    </div>

                    <!-- Preview Container -->
                    <div class="remarkable-preview eink-optimized p-4">
                        <div id="previewContent">
                            <!-- Weekly Overview (Default View) -->
                            <div id="weeklyPreview">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-lg font-bold text-gray-800">Week Overview</h3>
                                    <div class="flex items-center space-x-2">
                                        <span class="text-xs text-gray-600">Week 47, 2024</span>
                                        <div class="sync-indicator bg-green-400"></div>
                                    </div>
                                </div>

                                <!-- Mini Calendar -->
                                <div class="calendar-grid mb-4 text-xs">
                                    <div class="bg-gray-200 p-1 text-center font-bold">Mon</div>
                                    <div class="bg-gray-200 p-1 text-center font-bold">Tue</div>
                                    <div class="bg-gray-200 p-1 text-center font-bold">Wed</div>
                                    <div class="bg-gray-200 p-1 text-center font-bold">Thu</div>
                                    <div class="bg-gray-200 p-1 text-center font-bold">Fri</div>
                                    <div class="bg-gray-200 p-1 text-center font-bold">Sat</div>
                                    <div class="bg-gray-200 p-1 text-center font-bold">Sun</div>

                                    <div class="bg-white p-2 text-center">
                                        <div class="font-medium">18</div>
                                        <div class="w-2 h-1 bg-blue-400 mx-auto mt-1 rounded"></div>
                                    </div>
                                    <div class="bg-white p-2 text-center">19</div>
                                    <div class="bg-white p-2 text-center">20</div>
                                    <div class="bg-white p-2 text-center">21</div>
                                    <div class="bg-white p-2 text-center">22</div>
                                    <div class="bg-white p-2 text-center">23</div>
                                    <div class="bg-white p-2 text-center">24</div>
                                </div>

                                <!-- Real Calendar Events Summary -->
                                <div class="grid grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <h4 class="text-sm font-bold mb-2">This Week's Events</h4>
                                        <div id="weeklyEventsSummary" class="space-y-1 text-xs text-gray-600">
                                            <div>Select calendars and sync to see your events</div>
                                        </div>
                                    </div>
                                    <div>
                                        <h4 class="text-sm font-bold mb-2">Calendar Status</h4>
                                        <div class="space-y-1">
                                            <div class="flex items-center text-xs">
                                                <div class="w-2 h-2 bg-green-400 rounded-full mr-2"></div>
                                                <span id="syncStatus">Ready to sync</span>
                                            </div>
                                            <div class="flex items-center text-xs">
                                                <div class="w-2 h-2 bg-blue-400 rounded-full mr-2"></div>
                                                <span id="eventCount">0 events loaded</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Habit Tracker -->
                                <div>
                                    <h4 class="text-sm font-bold mb-2">Habit Tracker</h4>
                                    <div class="grid grid-cols-7 gap-1 text-xs">
                                        <div class="text-center">M</div>
                                        <div class="text-center">T</div>
                                        <div class="text-center">W</div>
                                        <div class="text-center">T</div>
                                        <div class="text-center">F</div>
                                        <div class="text-center">S</div>
                                        <div class="text-center">S</div>

                                        <div class="w-4 h-4 bg-green-300 rounded-full mx-auto"></div>
                                        <div class="w-4 h-4 bg-green-300 rounded-full mx-auto"></div>
                                        <div class="w-4 h-4 border border-gray-400 rounded-full mx-auto"></div>
                                        <div class="w-4 h-4 border border-gray-400 rounded-full mx-auto"></div>
                                        <div class="w-4 h-4 border border-gray-400 rounded-full mx-auto"></div>
                                        <div class="w-4 h-4 border border-gray-400 rounded-full mx-auto"></div>
                                        <div class="w-4 h-4 border border-gray-400 rounded-full mx-auto"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Daily View Template (Hidden by default) -->
                            <div id="dailyPreview" class="hidden">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-lg font-bold text-gray-800">Monday, Nov 18, 2024</h3>
                                    <div class="flex items-center space-x-2">
                                        <button class="text-xs bg-gray-200 px-2 py-1 rounded">‚Üê Week</button>
                                        <div class="sync-indicator bg-green-400"></div>
                                    </div>
                                </div>

                                <div class="grid grid-cols-12 gap-2 text-xs">
                                    <!-- Time Column -->
                                    <div class="col-span-2 space-y-2">
                                        <div class="time-slot text-right pr-2 text-gray-600">06:00</div>
                                        <div class="time-slot text-right pr-2 text-gray-600">07:00</div>
                                        <div class="time-slot text-right pr-2 text-gray-600">08:00</div>
                                        <div class="time-slot text-right pr-2 text-gray-600">09:00</div>
                                        <div class="time-slot text-right pr-2 text-gray-600">10:00</div>
                                        <div class="time-slot text-right pr-2 text-gray-600">11:00</div>
                                        <div class="time-slot text-right pr-2 text-gray-600">12:00</div>
                                        <div class="time-slot text-right pr-2 text-gray-600">13:00</div>
                                    </div>

                                    <!-- Schedule Column - Real Events -->
                                    <div id="dailySchedule" class="col-span-7 space-y-2">
                                        <div class="time-slot"></div>
                                        <div class="time-slot"></div>
                                        <div class="time-slot"></div>
                                        <div class="time-slot"></div>
                                        <div class="time-slot"></div>
                                        <div class="time-slot"></div>
                                        <div class="time-slot"></div>
                                        <div class="time-slot"></div>
                                    </div>

                                    <!-- Sidebar -->
                                    <div class="col-span-3">
                                        <div class="bg-gray-50 p-2 rounded mb-2">
                                            <h5 class="font-bold mb-1">Day Overview</h5>
                                            <div id="dayOverview" class="text-xs text-gray-600">Sync calendars to see today's focus</div>
                                        </div>

                                        <div class="bg-gray-50 p-2 rounded mb-2">
                                            <h5 class="font-bold mb-1">Today's Events</h5>
                                            <div id="todaysEvents" class="space-y-1 text-xs text-gray-600">
                                                <div>No events synced yet</div>
                                            </div>
                                        </div>

                                        <div class="bg-gray-50 p-2 rounded">
                                            <h5 class="font-bold mb-1">Energy</h5>
                                            <div class="flex space-x-1">
                                                <div class="w-2 h-2 bg-green-400 rounded-full"></div>
                                                <div class="w-2 h-2 bg-green-400 rounded-full"></div>
                                                <div class="w-2 h-2 bg-green-400 rounded-full"></div>
                                                <div class="w-2 h-2 bg-gray-300 rounded-full"></div>
                                                <div class="w-2 h-2 bg-gray-300 rounded-full"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Export Actions -->
                    <div class="mt-6 flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <div class="text-sm text-gray-600">
                                <i class="fas fa-info-circle mr-1"></i>
                                8 pages ‚Ä¢ PDF format ‚Ä¢ Google sync enabled
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button id="generatePDF" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors">
                                <i class="fas fa-download mr-2"></i>
                                Generate PDF
                            </button>
                            <button id="deployToReplit" class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition-colors">
                                <i class="fas fa-rocket mr-2"></i>
                                Deploy to Replit
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Bar -->
        <div class="mt-8 bg-white rounded-xl shadow-lg p-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <div class="w-3 h-3 bg-green-400 rounded-full"></div>
                        <span class="text-sm text-gray-600">Template Ready</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="w-3 h-3 bg-blue-400 rounded-full"></div>
                        <span class="text-sm text-gray-600">Google Calendar: <span id="calendarStatus">Disconnected</span></span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="w-3 h-3 bg-yellow-400 rounded-full"></div>
                        <span class="text-sm text-gray-600">Export: Ready</span>
                    </div>
                </div>
                <div class="text-sm text-gray-500">
                    Last updated: <span id="lastUpdate">Never</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let gapi_loaded = false;
        let isSignedIn = false;
        let currentPage = 0;
        let calendarEvents = [];
        let tokenClient = null;
        let accessToken = null;

        // Initialize Backend API (Server-side OAuth)
        function initializeGapi() {
            console.log('Starting backend API initialization...');
            
            // Check if backend config is available
            if (!window.BACKEND_CONFIG) {
                console.error('Backend config not loaded');
                setTimeout(initializeGapi, 500);
                return;
            }
            
            console.log('Backend config loaded:', window.BACKEND_CONFIG);
            gapi_loaded = true;
            
            // Check authentication status
            checkAuthStatus();
        }
        
        // Check authentication status with backend
        async function checkAuthStatus() {
            try {
                const response = await fetch('/auth/status');
                const data = await response.json();
                
                isSignedIn = data.authenticated;
                console.log('Auth status:', isSignedIn ? 'authenticated' : 'not authenticated');
                
                updateAuthUI();
                
                // Load calendars if authenticated
                if (isSignedIn) {
                    loadCalendars();
                }
                
            } catch (error) {
                console.error('Error checking auth status:', error);
                isSignedIn = false;
                updateAuthUI();
            }
        }

        // Update authentication UI
        function updateAuthUI() {
            const authButton = document.getElementById('authButton');
            const authStatus = document.getElementById('authStatus');
            const syncIndicator = document.getElementById('syncIndicator');
            const syncButton = document.getElementById('syncNow');
            const calendarStatus = document.getElementById('calendarStatus');

            if (isSignedIn) {
                authButton.innerHTML = '<i class="fas fa-sign-out-alt mr-2"></i>Disconnect';
                authStatus.querySelector('span').textContent = 'Connected';
                syncIndicator.className = 'sync-indicator bg-green-400';
                syncButton.disabled = false;
                calendarStatus.textContent = 'Connected';
                loadCalendars();
            } else {
                authButton.innerHTML = '<i class="fab fa-google mr-2"></i>Connect Google';
                authStatus.querySelector('span').textContent = 'Not Connected';
                syncIndicator.className = 'sync-indicator bg-yellow-400';
                syncButton.disabled = true;
                calendarStatus.textContent = 'Disconnected';
            }
        }

        // Handle authentication (Server-side OAuth)
        function handleAuth() {
            console.log('=== AUTH BUTTON CLICKED ===');
            console.log('gapi_loaded:', gapi_loaded);
            console.log('isSignedIn:', isSignedIn);
            
            if (!gapi_loaded) {
                console.error('Backend API not ready yet');
                alert('Backend is still loading. Please try again in a moment.');
                return;
            }
            
            if (isSignedIn) {
                console.log('Logging out...');
                fetch('/auth/logout', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Logout successful:', data);
                        isSignedIn = false;
                        updateAuthUI();
                        
                        // Clear calendar list
                        const calendarListEl = document.getElementById('calendarList');
                        calendarListEl.innerHTML = '<div class="text-gray-500 text-center py-4">Connect Google Calendar to sync events</div>';
                    })
                    .catch(error => {
                        console.error('Logout error:', error);
                        alert('Error logging out: ' + error.message);
                    });
            } else {
                console.log('=== STARTING SERVER-SIDE OAUTH FLOW ===');
                // Redirect to server-side OAuth endpoint
                window.location.href = '/auth/google';
            }
        }

        // Load user calendars (Server-side)
        async function loadCalendars() {
            try {
                const response = await fetch('/api/calendars');
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to load calendars');
                }
                
                const calendars = data.calendars;
                console.log('Found calendars:', calendars.length);
                calendars.forEach(cal => console.log(`Calendar: ${cal.summary} (${cal.id}) - Primary: ${cal.primary}`));

                const calendarListEl = document.getElementById('calendarList');
                calendarListEl.innerHTML = calendars.map(calendar => {
                    const isMainCalendar = calendar.primary || calendar.id.includes('@gmail.com');
                    return `
                        <label class="flex items-center space-x-2 p-2 hover:bg-gray-50 rounded border ${isMainCalendar ? 'border-blue-200 bg-blue-50' : 'border-gray-200'}">
                            <input type="checkbox" class="calendar-checkbox" data-calendar-id="${calendar.id}" ${calendar.primary ? 'checked' : ''}>
                            <div class="w-4 h-4 rounded" style="background-color: ${calendar.backgroundColor || '#3b82f6'}"></div>
                            <div class="flex flex-col">
                                <span class="text-sm font-medium">${calendar.summary}</span>
                                <span class="text-xs text-gray-500">${calendar.accessRole || 'reader'} ${isMainCalendar ? '(Main)' : ''}</span>
                            </div>
                        </label>
                    `;
                }).join('');

                // Update status
                const calendarStatus = document.getElementById('calendarStatus');
                calendarStatus.textContent = `${calendars.length} calendars found`;

            } catch (error) {
                console.error('Error loading calendars:', error);
                const calendarListEl = document.getElementById('calendarList');
                calendarListEl.innerHTML = `
                    <div class="text-red-500 text-center py-4">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        Error loading calendars: ${error.message}
                    </div>
                `;
            }
        }

        // Sync calendar events (Server-side)
        async function syncCalendarEvents() {
            if (!isSignedIn) return;

            const selectedCalendars = Array.from(document.querySelectorAll('.calendar-checkbox:checked'))
                .map(cb => cb.dataset.calendarId);

            if (selectedCalendars.length === 0) {
                alert('Please select at least one calendar to sync');
                return;
            }

            // Check sync range option
            const syncRange = document.querySelector('input[name="syncRange"]:checked')?.value || 'week';
            const isFullRange = syncRange === 'full';

            const weekStart = document.getElementById('weekStart').value;
            
            calendarEvents = [];

            try {
                // Show loading state
                const syncButton = document.getElementById('syncNow');
                const originalText = syncButton.innerHTML;
                syncButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Syncing...';
                syncButton.disabled = true;

                // Build query parameters
                const params = new URLSearchParams();
                selectedCalendars.forEach(id => params.append('calendar_ids', id));
                
                if (isFullRange) {
                    // Full range (2015-2030)
                    params.append('full_range', 'true');
                    console.log('üóìÔ∏è Loading events from 2015-2030 (this may take a moment)...');
                } else {
                    // Weekly range
                    if (!weekStart) {
                        alert('Please select a week start date');
                        syncButton.innerHTML = originalText;
                        syncButton.disabled = false;
                        return;
                    }
                    const startDate = new Date(weekStart);
                    const endDate = new Date(startDate);
                    endDate.setDate(endDate.getDate() + 7);
                    params.append('time_min', startDate.toISOString());
                    params.append('time_max', endDate.toISOString());
                }

                const response = await fetch(`/api/events?${params.toString()}`);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to fetch events');
                }
                
                calendarEvents = data.events || [];
                const range = data.date_range || 'selected period';
                console.log(`üìã Synced ${calendarEvents.length} events from ${selectedCalendars.length} calendars (${range})`);
                
                // Update UI with success message
                alert(`Successfully synced ${calendarEvents.length} events from ${range}!`);
                
                // Restore button
                syncButton.innerHTML = originalText;
                syncButton.disabled = false;
                
            } catch (error) {
                console.error('Error fetching events:', error);
                alert('Failed to sync calendar events: ' + error.message);
                
                // Restore button on error
                const syncButton = document.getElementById('syncNow');
                syncButton.innerHTML = '<i class="fas fa-sync-alt mr-2"></i>Sync Calendar Events';
                syncButton.disabled = false;
            }

            updateLastUpdateTime();
            refreshPreview();
        }

        // Update preview based on current page
        function refreshPreview() {
            // Update the preview with real calendar events
            if (calendarEvents && calendarEvents.length > 0) {
                console.log(`Refreshing preview with ${calendarEvents.length} calendar events`);
                updateEventsSummary();
                updateDailyView();
                updateEventCount();
            } else {
                clearPreviewData();
            }
            updateLastUpdateTime();
        }
        
        // Update events summary in weekly view
        function updateEventsSummary() {
            const summaryEl = document.getElementById('weeklyEventsSummary');
            if (!summaryEl || !calendarEvents || calendarEvents.length === 0) return;
            
            const upcomingEvents = calendarEvents.slice(0, 3); // Show first 3 events
            summaryEl.innerHTML = upcomingEvents.map(event => 
                `<div class="flex items-center">
                    <div class="w-2 h-2 bg-blue-400 rounded-full mr-2"></div>
                    <span>${event.summary || 'Untitled Event'}</span>
                </div>`
            ).join('') || '<div>No events to display</div>';
        }
        
        // Update daily view with real events
        function updateDailyView() {
            // Update day overview
            const overviewEl = document.getElementById('dayOverview');
            if (overviewEl && calendarEvents && calendarEvents.length > 0) {
                overviewEl.textContent = `${calendarEvents.length} events synced from your calendars`;
            }
            
            // Update today's events list
            const todaysEl = document.getElementById('todaysEvents');
            if (todaysEl && calendarEvents && calendarEvents.length > 0) {
                const eventsList = calendarEvents.slice(0, 5).map(event => 
                    `<div class="flex items-center">
                        <div class="w-2 h-2 bg-green-400 rounded-full mr-1"></div>
                        <span>${event.summary || 'Untitled Event'}</span>
                    </div>`
                ).join('');
                todaysEl.innerHTML = eventsList || '<div>No events for today</div>';
            }
        }
        
        // Update event count display
        function updateEventCount() {
            const countEl = document.getElementById('eventCount');
            if (countEl) {
                const count = calendarEvents ? calendarEvents.length : 0;
                countEl.textContent = `${count} events loaded`;
            }
            
            const statusEl = document.getElementById('syncStatus');
            if (statusEl) {
                statusEl.textContent = calendarEvents && calendarEvents.length > 0 ? 'Synced successfully' : 'Ready to sync';
            }
        }
        
        // Clear preview data when no events
        function clearPreviewData() {
            const summaryEl = document.getElementById('weeklyEventsSummary');
            if (summaryEl) summaryEl.innerHTML = '<div>Select calendars and sync to see your events</div>';
            
            const overviewEl = document.getElementById('dayOverview');
            if (overviewEl) overviewEl.textContent = 'Sync calendars to see today\'s focus';
            
            const todaysEl = document.getElementById('todaysEvents');
            if (todaysEl) todaysEl.innerHTML = '<div>No events synced yet</div>';
        }

        // Switch preview pages
        function switchPage(pageIndex) {
            currentPage = pageIndex;

            // Update navigation buttons
            document.querySelectorAll('.page-nav-btn').forEach((btn, index) => {
                if (index === pageIndex) {
                    btn.className = 'page-nav-btn bg-purple-600 text-white px-3 py-1 rounded text-sm hover:bg-purple-700 transition-colors';
                } else {
                    btn.className = 'page-nav-btn bg-gray-300 text-gray-700 px-3 py-1 rounded text-sm hover:bg-gray-400 transition-colors';
                }
            });

            // Show/hide preview content
            const weeklyPreview = document.getElementById('weeklyPreview');
            const dailyPreview = document.getElementById('dailyPreview');

            if (pageIndex === 0) {
                weeklyPreview.classList.remove('hidden');
                dailyPreview.classList.add('hidden');
            } else {
                weeklyPreview.classList.add('hidden');
                dailyPreview.classList.remove('hidden');

                // Update daily preview for selected day
                const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
                const dayName = days[pageIndex - 1];
                
                // Get actual date from selected week
                const weekStart = document.getElementById('weekStart').value;
                if (weekStart) {
                    const startDate = new Date(weekStart);
                    const dayDate = new Date(startDate);
                    dayDate.setDate(startDate.getDate() + (pageIndex - 1));
                    
                    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                    dailyPreview.querySelector('h3').textContent = dayDate.toLocaleDateString('en-US', options);
                } else {
                    dailyPreview.querySelector('h3').textContent = `${dayName} - Select week start date`;
                }
            }
        }

        // Generate PDF
        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'landscape',
                unit: 'px',
                format: [2880, 2160]
            });

            // This is a simplified PDF generation
            // In a real implementation, you would render each page with proper layout
            for (let page = 0; page < 8; page++) {
                if (page > 0) doc.addPage();

                doc.setFontSize(24);
                if (page === 0) {
                    doc.text('reMarkable Pro Move - Weekly Overview', 100, 100);
                } else {
                    const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
                    doc.text(`reMarkable Pro Move - ${days[page - 1]}`, 100, 100);
                }

                // Add grid lines and template structure
                doc.setDrawColor(128, 128, 128);
                doc.setLineWidth(1);

                // Draw basic grid structure
                for (let i = 0; i < 24; i++) {
                    const y = 200 + (i * 60);
                    doc.line(50, y, 2800, y);
                    doc.text(`${i.toString().padStart(2, '0')}:00`, 20, y + 15);
                }

                // Add vertical lines for time blocks
                for (let i = 0; i < 7; i++) {
                    const x = 300 + (i * 350);
                    doc.line(x, 150, x, 2000);
                }
            }

            const weekStart = document.getElementById('weekStart').value || new Date().toISOString().split('T')[0];
            doc.save(`remarkable_calendar_${weekStart}.pdf`);

            updateLastUpdateTime();
        }

        // Deploy to Replit
        function deployToReplit() {
            // Check if we have calendars and events synced
            if (!isSignedIn) {
                alert('Please connect your Google Calendar first before deploying.');
                return;
            }
            
            const selectedCalendars = Array.from(document.querySelectorAll('.calendar-checkbox:checked'));
            if (selectedCalendars.length === 0) {
                alert('Please select at least one calendar to sync before deploying.');
                return;
            }
            
            // This application is already deployed on Replit and ready to use
            alert('Your reMarkable Calendar Generator is ready! All your calendar data is securely stored and synced. You can now generate PDF templates for your reMarkable device.');
        }

        // Update last update time
        function updateLastUpdateTime() {
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        }

        // Initialize date input with current week
        function initializeDateInput() {
            const today = new Date();
            const monday = new Date(today);
            monday.setDate(today.getDate() - today.getDay() + 1);
            document.getElementById('weekStart').value = monday.toISOString().split('T')[0];
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            initializeDateInput();
            updateLastUpdateTime();

            // Auth button
            document.getElementById('authButton').addEventListener('click', handleAuth);

            // Sync button
            document.getElementById('syncNow').addEventListener('click', syncCalendarEvents);

            // Page navigation
            document.querySelectorAll('.page-nav-btn').forEach((btn, index) => {
                btn.addEventListener('click', () => switchPage(index));
            });

            // Generate PDF button
            document.getElementById('generatePDF').addEventListener('click', generatePDF);

            // Deploy button
            document.getElementById('deployToReplit').addEventListener('click', deployToReplit);

            // Configuration changes
            document.getElementById('weekStart').addEventListener('change', refreshPreview);
            document.getElementById('timeFormat').addEventListener('change', refreshPreview);
            document.getElementById('showHabits').addEventListener('change', refreshPreview);
            document.getElementById('showDecisions').addEventListener('change', refreshPreview);
            document.getElementById('showEnergy').addEventListener('change', refreshPreview);

            // Theme selection
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.theme-btn').forEach(b => 
                        b.classList.remove('border-purple-500'));
                    e.target.closest('.theme-btn').classList.add('border-purple-500');
                    refreshPreview();
                });
            });

            // Set default theme
            document.querySelector('.theme-btn[data-theme="sage"]').classList.add('border-purple-500');

            // Show loading state initially
            const authButton = document.getElementById('authButton');
            authButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Loading...';
            authButton.disabled = true;

            // Initialize Google API when page loads (after a delay to ensure all resources are loaded)
            setTimeout(initializeGapi, 1000);
            
            // Check for OAuth success parameter in URL
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('auth') === 'success') {
                console.log('OAuth success detected, will refresh auth status');
                // Remove the parameter from URL
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        });
    </script>
</body>
</html>